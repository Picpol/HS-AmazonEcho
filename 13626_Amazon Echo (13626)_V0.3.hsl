# -*- coding: iso8859-1 -*-
## -----------------------------------------------------
## Amazon Echo (13626)   ### V0.3
##
## erstellt am: 2017-02-19 16:20
## -----------------------------------------------------
## Copyright © 2016, Werner Lindbüchl, All rights reserved.
##
## This program is free software; you can redistribute it and/or modify it under the terms
## of the GNU General Public License as published by the Free Software Foundation; either
## version 3 of the License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
## without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
## See the GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License along with this program;
## if not, see <http://www.gnu.de/documents/gpl-3.0.de.html>.

## -- 
## --  

#5000|"Text"|Remanent(1/0)|Anz.Eingänge|.n.|Anzahl Ausgänge|.n.|.n.
5000|"Weitere Bausteine\Amazon Echo (13626)_V0.3"|1|5|"E1 Https-Server Start/Stop"|"E2 Https-Server Port"|"E3 Access Token"|"E4 Loglevel 0=Off, 1=Error, 2=Warn, 3=Info, 4=Debug"|"E5 Clear Log"|1|"A1 Unauthorized Access Counter"|"V0.3"

#5001|Anzahl Eingänge|Ausgänge|Offset|Speicher|Berechnung bei Start
5001|5|1|1|6|1

# Eingaenge
#5002|Index Eingang|Default Wert|0=numerisch 1=alphanummerisch
5002|1|1|0	#* E1 Https-Server Start/Stop 
5002|2|0|0	#* E2 Https-Server Port 
5002|3|0|1	#* E3 Access Token 
5002|4|2|0	#* E4 LogLevel 
5002|5|0|0	#* E5 Clear Log 

# Speicher
#5003|Speicher|Initwert|Remanent
5003|1||0		  #* 
5003|2|""|1		  #*  Bytes - 10000
5003|3|""|1		  #*  Bytes - 20000
5003|4|""|1		  #*  Bytes - 30000
5003|5|""|1		  #*  Bytes - 40000
5003|6|""|1		  #*  Bytes - 50000

# Ausgaenge
#5004|ausgang|Initwert|runden binär (0/1)|typ (1-send/2-sbc)|0=numerisch 1=alphanummerisch
5004|1|0|0|1|0 #* A1 Unauthorized Access Counter

#################################################

5012|0|"EI"|"eval(compile(__import__('base64').decodestring('CmlmIEVJPT0xOgogIGdsb2JhbCBhc0RpY3QKICBkZWYgYXNEaWN0KG8pOgogICAgICByZXR1cm4gby5fX2RpY3RfXwogIGdsb2JhbCBIVFRQU2VydmVyCiAgZ2xvYmFsIEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBmcm9tIEJhc2VIVFRQU2VydmVyIGltcG9ydCBIVFRQU2VydmVyLEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKICBnbG9iYWwgVGhyZWFkaW5nTWl4SW4KICBmcm9tIFNvY2tldFNlcnZlciBpbXBvcnQgVGhyZWFkaW5nTWl4SW4KICBnbG9iYWwganNvbgogIGltcG9ydCBqc29uCiAgZ2xvYmFsIEFtYXpvbkVjaG8KICBjbGFzcyBBbWF6b25FY2hvKFRocmVhZGluZ01peEluLCBIVFRQU2VydmVyKToKICAgIEhTID0gVHJ1ZQogICAgREVMQVkgPSAyMAogICAgTUlOX0ZJUk1XQVJFX1ZFUlNJT04gPSA0LjIKICAgIFBBUlRfU0laRSA9IDEwMDAwCiAgICBNQVhfUEFSVCA9IDUKICAgIGlmIEhTOgogICAgICBQQVRIX0JBU0UgPSAiL3RtcC8iCiAgICBlbHNlOgogICAgICBQQVRIX0JBU0UgPSAiIgogICAgRklMRU5BTUVfQ0VSVCA9ICJhbWF6b25FY2hvU1NMLmNlcnQiCiAgICBGSUxFUEFUSF9DRVJUID0gUEFUSF9CQVNFICsgRklMRU5BTUVfQ0VSVAogICAgRklMRU5BTUVfTE9HID0gIjEzNjI2LmxvZyIKICAgIEZJTEVQQVRIX0xPRyA9IFBBVEhfQkFTRSArIEZJTEVOQU1FX0xPRwogICAgVVJMX0JBU0UgPSAiYW1hem9uRWNoby8iCiAgICBVUkxfU0hPV19TU0wgPSBVUkxfQkFTRSArICJzc2xDZXJ0Lmh0bSIKICAgIFVSTF9TSE9XX0xPRyA9IFVSTF9CQVNFICsgImxvZy5odG0iCiAgICBhbGxvd19yZXVzZV9hZGRyZXNzID0gVHJ1ZQogICAgZGVmIF9faW5pdF9fKHNlbGYsIGxvY2Fscyk6CiAgICAgIHNlbGYubG9jYWxzID0gbG9jYWxzOwogICAgICBzZWxmLmxvZ2lrID0gbG9jYWxzWydwSXRlbSddCiAgICAgIHNlbGYuTUMgPSBzZWxmLmxvZ2lrLk1DCiAgICAgIHNlbGYuaHNJcCA9IHNlbGYuTUMuRXRoZXJuZXQuSVBBZHIKICAgICAgc2VsZi5oc1BvcnQgPSBzZWxmLk1DLkV0aGVybmV0LklQUG9ydAogICAgICBFTiA9IGxvY2Fsc1snRU4nXQogICAgICBzZWxmLlNUQVJUID0gRU5bMV0KICAgICAgc2VsZi5wb3J0ID0gaW50KEVOWzJdKQogICAgICBzZWxmLmFjY2Vzc1Rva2VuID0gRU5bM10uZGVjb2RlKCdpc284ODU5LTEnKQogICAgICBzZWxmLmxvZ0xldmVsID0gRU5bNF0KICAgICAgc2VsZi5pbml0aWFsaXplZCA9IEZhbHNlCiAgICAgIHNlbGYuY2VydFRleHQgPSAiIgogICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyID0gMAogICAgICBzZWxmLnZlcnNpb24gPSB1J0FtYXpvbiBFY2hvIFNlcnZpY2UgVjAuMyB2b20gMTkuMDIuMjAxNyAxNjoyMCAgLSAgKFB5dGhvbiBWZXJzaW9uOiAnICsgc2VsZi5fZ2V0UHl0aG9uVmVyc2lvbigpICsgJyBEZWZhdWx0IEVuY29kaW5nOicgKyBzZWxmLl9nZXREZWZhdWx0RW5jb2RpbmcoKSArICcpJwogICAgICB0cnk6CiAgICAgICAgaW1wb3J0IGNvZGVjcwogICAgICAgIHNlbGYubG9nRmlsZSA9IGNvZGVjcy5vcGVuKHNlbGYuRklMRVBBVEhfTE9HLCAidysiLCAiSVNPLTg4NTktMSIpCiAgICAgICAgc2VsZi5sb2coc2VsZi52ZXJzaW9uKQogICAgICAgIHNlbGYuZmlybXdhcmVWZXJzaW9uID0gc2VsZi5fZ2V0RmlybXdhcmVWZXJzaW9uKCkKICAgICAgICBzZWxmLmZpcm13YXJlT2sgPSBzZWxmLmZpcm13YXJlVmVyc2lvbiA+PSBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OCiAgICAgICAgaWYgbm90IHNlbGYuZmlybXdhcmVPazoKICAgICAgICAgIHNlbGYubG9nKCJTb3JyeSwgeW91ciBHaXJhLUhvbWVzZXJ2ZXIgRmlybXdhcmUgaXMgbm90IHN1cHBvcnRlZCAtIGZvdW5kID0gJ3swfScgbmVlZGVkID49ICd7MX0nLiIsIHNlbGYuZmlybXdhcmVWZXJzaW9uLCBzZWxmLk1JTl9GSVJNV0FSRV9WRVJTSU9OKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgc2VsZi5sb2coIkluaXRpYXRlIHswfSBzZWNvbmRzIGRlbGF5IGZvciBIUyB0byBiZSBmdWxseSB1cCBhbmQgcnVubmluZyAuLi4iLCBBbWF6b25FY2hvLkRFTEFZKQogICAgICAgIEFtYXpvbkVjaG9XZWJDYWxsYmFjayhzZWxmLmxvZ2lrLCBzZWxmLCBzZWxmLndlYkNhbGxiYWNrU1NMQ2VydCwgc2VsZi5VUkxfU0hPV19TU0wpCiAgICAgICAgQW1hem9uRWNob1dlYkNhbGxiYWNrKHNlbGYubG9naWssIHNlbGYsIHNlbGYud2ViQ2FsbGJhY2tMb2csIHNlbGYuVVJMX1NIT1dfTE9HKQogICAgICBleGNlcHQ6CiAgICAgICAgc2VsZi5NQy5EZWJ1Zy5zZXRFcnIoc3lzLmV4Y19pbmZvKCksIkFtYXpvbkVjaG86IF9faW5pdF9fKCkgZmFpbGVkLiIpCiAgICBkZWYgX2dldFB5dGhvblZlcnNpb24oc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMudmVyc2lvbl9pbmZvKQogICAgZGVmIF9nZXREZWZhdWx0RW5jb2Rpbmcoc2VsZik6CiAgICAgIGltcG9ydCBzeXMKICAgICAgcmV0dXJuIHN0cihzeXMuZ2V0ZGVmYXVsdGVuY29kaW5nKCkpCiAgICBkZWYgX2dldEZpcm13YXJlVmVyc2lvbihzZWxmKToKICAgICAgaW1wb3J0IHJlCiAgICAgIF9maXJtd2FyZSA9IHJlLmZpbmRhbGwoIl4oXGQrXC5cZCspIiwgc2VsZi5NQy5EZWJ1Zy5WZXJzaW9uKQogICAgICBpZiBub3QgX2Zpcm13YXJlOgogICAgICAgIF9maXJtd2FyZSA9IFsiMC4wIl0KICAgICAgcmV0dXJuIGZsb2F0KF9maXJtd2FyZVswXSkKICAgIGRlZiBpbml0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgc2VsZi5sb2coIkluaXRpYWxpemUgQW1hem9uIEVjaG8gU2VydmljZS4iKQogICAgICAgIHNlbGYuY2VydFRleHQgPSBzZWxmLmdldFNTTENlcnQoc2VsZi5GSUxFTkFNRV9DRVJUKQogICAgICAgIGlmIHNlbGYuY2VydFRleHQgPT0gIiI6CiAgICAgICAgICBzZWxmLmNlcnRUZXh0ID0gc2VsZi5nZXRTU0xDZXJ0T2xkKHNlbGYuaHNJcCwgc2VsZi5oc1BvcnQsIHNlbGYuRklMRU5BTUVfQ0VSVCkKICAgICAgICBpZiBzZWxmLmNlcnRUZXh0ICE9ICIiOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmNlcnRUZXh0LmluZGV4KCJQcm9jLVR5cGU6IDQsRU5DUllQVEVEIikKICAgICAgICAgICAgc2VsZi5sb2coIlNTTCBjZXJ0aWZpY2F0ZXMgd2hpY2ggbmVlZHMgYSBwYXNzcGhyYXNlIGFyZSBub3Qgc3VwcG9ydGVkLiBQbGVhc2UgcmVtb3ZlIHBhc3NwaHJhc2UgYW5kIHVwbG9hZCBhZ2Fpbi4iKQogICAgICAgICAgICBzZWxmLmNlcnRUZXh0ID0gIiIKICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBzZWxmLmxvZygiU1NMIGNlcnRpZmljYXRlIGxvYWRlZCBzdWNjZXNzZnVsbHkgLSB3cml0aW5nIGl0IHRvIGZpbGUgJ3swfScuIiwgc2VsZi5GSUxFUEFUSF9DRVJUKQogICAgICAgICAgICB3aXRoIG9wZW4oc2VsZi5GSUxFUEFUSF9DRVJULCAid2IiKSBhcyBvdXRwdXQ6CiAgICAgICAgICAgICAgb3V0cHV0LndyaXRlKHNlbGYuY2VydFRleHQpCiAgICAgICAgc2VsZi5pbml0X2RlYnVnX2VudHJ5KCk7CiAgICAgICAgc2VsZi5yZWFkQXBwbGlhbmNlc0NvbmYoKQogICAgICAgIHNlbGYuaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgaWYgc2VsZi5TVEFSVDoKICAgICAgICAgIHNlbGYuc3RhcnQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBub3Qgc3RhcnRlZCAoQmF1c3RlaW4tRWluZ2FuZzogU3RhcnQvU3RvcCBpcyAwKSIpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogaW5pdCgpIGZhaWxlZC4iKQogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICBpZiBub3Qgc2VsZi5maXJtd2FyZU9rOgogICAgICAgIHJldHVybgogICAgICB0cnk6CiAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZWQ6CiAgICAgICAgICBzZWxmLlNUQVJUID0gVHJ1ZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgTm9uZToKICAgICAgICAgIHNlbGYubG9nKCJTdGFydGluZyBBbWF6b24gRWNobyBTZXJ2aWNlLiIpCiAgICAgICAgICBzZWxmLnVuYXV0aG9yaXplZENvdW50ZXIgPSAwIAogICAgICAgICAgSFRUUFNlcnZlci5fX2luaXRfXyhzZWxmLCAoc2VsZi5oc0lwLCBzZWxmLnBvcnQpLCBzZWxmLkhUVFBSZXF1ZXN0SGFuZGxlcikKICAgICAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgICAgIGltcG9ydCBzc2wKICAgICAgICAgICAgc2VsZi5zb2NrZXQgPSBzc2wud3JhcF9zb2NrZXQoc2VsZi5zb2NrZXQsIGNlcnRmaWxlPXNlbGYuRklMRVBBVEhfQ0VSVCwgc2VydmVyX3NpZGU9VHJ1ZSkKICAgICAgICAgIGZyb20gaHNfcXVldWUgaW1wb3J0IGhzX3RocmVhZGluZyBhcyB0aHJlYWRpbmcKICAgICAgICAgIHNlbGYuc2VydmVyVGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5zZXJ2ZV9mb3JldmVyLCBuYW1lPSdhbWF6b25fZWNob19zZXJ2ZXInKQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgc2VsZi5zZXJ2ZXJUaHJlYWQuc3RhcnQoKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBhbHJlYWR5IHN0YXJ0ZWQuIikKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJBbWF6b25FY2hvOiBzdGFydCgpIGZhaWxlZC4iKQogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgIGlmIG5vdCBzZWxmLmZpcm13YXJlT2s6CiAgICAgICAgcmV0dXJuCiAgICAgIHRyeToKICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplZDoKICAgICAgICAgIHNlbGYuU1RBUlQgPSBmYWxzZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXJUaHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICBIVFRQU2VydmVyLnNodXRkb3duKHNlbGYpCiAgICAgICAgICBzZWxmLnNvY2tldC5jbG9zZSgpCiAgICAgICAgICBzZWxmLnNlcnZlclRocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLmxvZygiQW1hem9uIEVjaG8gU2VydmljZSBzdG9wcGVkLiIpCiAgICAgIGV4Y2VwdDoKICAgICAgICBzZWxmLk1DLkRlYnVnLnNldEVycihzeXMuZXhjX2luZm8oKSwiQW1hem9uRWNobzogc3RvcCgpIGZhaWxlZC4iKQogICAgZGVmIHJlYWRBcHBsaWFuY2VzQ29uZihzZWxmKToKICAgICAgc2VsZi5kZWJ1ZygicmVhZEFwcGxpYW5jZXNDb25mKCkiKQogICAgICB0cnk6CiAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0gTm9uZQogICAgICAgIFNOID0gc2VsZi5sb2NhbHNbJ1NOJ10KICAgICAgICBhcHBsaWFuY2VzVGV4dCA9ICIiCiAgICAgICAgZm9yIGlkeCBpbiByYW5nZSgwLCBzZWxmLk1BWF9QQVJUKToKICAgICAgICAgIHBhcnQgPSBTTltpZHggKyAyXQogICAgICAgICAgaWYgcGFydCBpcyBub3QgTm9uZSBhbmQgdHlwZShwYXJ0KSBpcyBzdHI6CiAgICAgICAgICAgIGFwcGxpYW5jZXNUZXh0ICs9IHBhcnQKICAgICAgICBpZiBhcHBsaWFuY2VzVGV4dC5zdHJpcCgpICE9ICIiOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmFwcGxpYW5jZXMgPSBqc29uLmxvYWRzKHNlbGYucmVtb3ZlQ29tbWVudHMoYXBwbGlhbmNlc1RleHQpLCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvcjoKICAgICAgICAgICAgc2VsZi5pbmZvKCJUcnlpbmcgdG8gY29udmVydCBhcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gZm9ybSAnaXNvODg1OS0xJyB0byAndXRmLTgnLiIpCiAgICAgICAgICAgIGFwcGxpYW5jZXNUZXh0ID0gYXBwbGlhbmNlc1RleHQuZGVjb2RlKCdpc284ODU5LTEnKS5lbmNvZGUoJ3V0Zi04JykKICAgICAgICAgICAgc2VsZi5pbmZvKCJBcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gc3VjY2Vzc2Z1bGx5IGNvbnZlcnRlZC4iKQogICAgICAgICAgICBzZWxmLnNhdmVBcHBsaWFuY2VzQ29uZihhcHBsaWFuY2VzVGV4dCkKICAgICAgICAgIHNlbGYuaW5mbygiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHN1Y2Nlc3NmdWxseSBsb2FkZWQuIikKICAgICAgICBlbHNlOgogICAgICAgICAgc2VsZi53YXJuKCJBcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24gaXMgZW1wdHkuIikKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuZXhjKCJKc29uIGV4Y2VwdGlvbiB3aGlsZSBwYXJzaW5nIGFwcGxpYW5jZXMgY29uZmlndXJhdGlvbjoiKQogICAgZGVmIHNhdmVBcHBsaWFuY2VzQ29uZihzZWxmLCBhcHBsaWFuY2VzVGV4dCk6CiAgICAgIHNlbGYuaW5mbygiVHJ5aW5nIHRvIHNhdmUgYXBwbGlhbmNlcyBjb25maWd1cmF0aW9uLiIpCiAgICAgIG1zZyA9ICIiCiAgICAgIHN5bnRheEVycm9yID0gRmFsc2UKICAgICAgdHJ5OgogICAgICAgIGlmIGFwcGxpYW5jZXNUZXh0ICE9ICIiOgogICAgICAgICAganNvblRleHQgPSBzZWxmLnJlbW92ZUNvbW1lbnRzKGFwcGxpYW5jZXNUZXh0KQogICAgICAgICAgc2VsZi5hcHBsaWFuY2VzID0ganNvbi5sb2Fkcyhqc29uVGV4dCwgZW5jb2Rpbmc9InV0Zi04IikKICAgICAgICAgIHNlbGYuaW5mbygiQXBwbGlhbmNlcyBjb25maWd1cmF0aW9uIHN1Y2Nlc3NmdWxseSBzYXZlZC4iKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzZWxmLmFwcGxpYW5jZXMgPSBOb25lCiAgICAgICAgICBzZWxmLndhcm4oIkFwcGxpYW5jZXMgY29uZmlndXJhdGlvbiB3YXMgZW1wdHkuIikKICAgICAgICBTTiA9IHNlbGYubG9jYWxzWydTTiddCiAgICAgICAgYXBwbGlhbmNlc0xlbiA9IGxlbihhcHBsaWFuY2VzVGV4dCkKICAgICAgICBpZiBhcHBsaWFuY2VzTGVuIDw9IChzZWxmLk1BWF9QQVJUICogc2VsZi5QQVJUX1NJWkUpOgogICAgICAgICAgaWR4ID0gMAogICAgICAgICAgd2hpbGUgaWR4IDwgc2VsZi5NQVhfUEFSVDoKICAgICAgICAgICAgaWYgYXBwbGlhbmNlc0xlbiA+IChpZHggKyAxKSAqIHNlbGYuUEFSVF9TSVpFOgogICAgICAgICAgICAgIFNOW2lkeCArIDJdID0gYXBwbGlhbmNlc1RleHRbaWR4ICogc2VsZi5QQVJUX1NJWkU6IChpZHggKyAxKSAqIHNlbGYuUEFSVF9TSVpFXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgIFNOW2lkeCArIDJdID0gYXBwbGlhbmNlc1RleHRbaWR4ICogc2VsZi5QQVJUX1NJWkU6XQogICAgICAgICAgICAgIGlkeCArPSAxCiAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgaWR4ICs9IDEKICAgICAgICAgIHdoaWxlIGlkeCA8IHNlbGYuTUFYX1BBUlQ6CiAgICAgICAgICAgIFNOW2lkeCArIDJdID0gTm9uZQogICAgICAgICAgICBpZHggKz0gMQogICAgICAgIGVsc2U6CiAgICAgICAgICBtc2cgPSB1IkNvbmZpZ3VyYXRpb24gbm90IHNhdmVkLiBMZW5ndGggZXhjZWVkcyBtYXggb2YgezB9IGJ5dGVzLiIuZm9ybWF0KHNlbGYuTUFYX1BBUlQgKiBzZWxmLlBBUlRfU0laRSkKICAgICAgICAgIHJldHVybiBtc2csIHN5bnRheEVycm9yCiAgICAgICAgZm9yIGlkeCBpbiByYW5nZSgwLCBzZWxmLk1BWF9QQVJUKTogCiAgICAgICAgICBzZWxmLmxvZ2lrLlNwZWljaGVyV2VydFtpZHggKyAxXSA9IFNOW2lkeCArIDJdCiAgICAgICAgc2VsZi5NQy5TaWNoUXVldWUucHV0KFsxMDAsIHNlbGYubG9naWssIHNlbGYubG9naWsuU3BlaWNoZXJXZXJ0XSkKICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgc2VsZi5leGMoIkpzb24gZXhjZXB0aW9uIHdoaWxlIHBhcnNpbmcgYXBwbGlhbmNlcyBjb25maWd1cmF0aW9uOiIpCiAgICAgICAgbXNnID0gIkZhaWxlZCB0byBwYXJzZSBhcHBsaWFuY2VzIGNvbmZpZ3VyYXRpb24uIgogICAgICAgIHN5bnRheEVycm9yID0gVHJ1ZQogICAgICByZXR1cm4gbXNnLCBzeW50YXhFcnJvcgogICAgZGVmIHJlbW92ZUNvbW1lbnRzKHNlbGYsIHN0cmluZyk6CiAgICAgIGltcG9ydCByZSAgICAKICAgICAgcGF0dGVybiA9IHIiKFwiLio/XCJ8XCcuKj9cJyl8KC9cKi4qP1wqL3wvL1teXG5dKiQpIgogICAgICByZWdleCA9IHJlLmNvbXBpbGUocGF0dGVybiwgcmUuTVVMVElMSU5FfHJlLkRPVEFMTCkKICAgICAgZGVmIF9yZXBsYWNlcihtYXRjaCk6CiAgICAgICAgaWYgbWF0Y2guZ3JvdXAoMikgaXMgbm90IE5vbmU6CiAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBlbHNlOgogICAgICAgICAgcmV0dXJuIG1hdGNoLmdyb3VwKDEpCiAgICAgIHJldHVybiByZWdleC5zdWIoX3JlcGxhY2VyLCBzdHJpbmcpCiAgICBkZWYgZGlzY292ZXJ5KHNlbGYsIG1lc3NhZ2VJZCwgY3VzdG9tU2tpbGwpOgogICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UmVzcG9uc2UobWVzc2FnZUlkKQogICAgICBpZiBzZWxmLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgaWQgPSAwCiAgICAgICAgZm9yIGRldmljZSBpbiBzZWxmLmFwcGxpYW5jZXM6CiAgICAgICAgICByb29tID0gZGV2aWNlLmdldCgncm9vbScpCiAgICAgICAgICBpZCArPSAxCiAgICAgICAgICBpZFN0ciA9IGRldmljZS5nZXQoJ2lkJykKICAgICAgICAgIGlmIGlkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgIGlkU3RyID0gc3RyKGlkKQogICAgICAgICAgYXBwbGlhbmNlcyA9IGRldmljZS5nZXQoJ2FwcGxpYW5jZXMnKQogICAgICAgICAgaWYgYXBwbGlhbmNlcyBpcyBOb25lOgogICAgICAgICAgICBpZiByb29tIGlzIG5vdCBOb25lIGFuZCByb29tICE9ICIiOgogICAgICAgICAgICAgIGlmIGRldmljZS5nZXQoJ3RhcmdldFRlbXBlcmF0dXJlJykgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkaXNjb3ZlcnlBcHBsaWFuY2UgPSBBbWF6b25FY2hvLkRpc2NvdmVyeUFwcGxpYW5jZShpZFN0ciwgcm9vbSwgIlRoZXJtb3N0YXQiKQogICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgICAgICAgICBlbGlmIGN1c3RvbVNraWxsOgogICAgICAgICAgICAgICAgaWYgKGRldmljZS5nZXQoJ2FjdHVhbFRlbXBlcmF0dXJlJykgaXMgbm90IE5vbmUKICAgICAgICAgICAgICAgICAgb3IgZGV2aWNlLmdldCgndGV4dCcpIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIsIHJvb20sIE5vbmUpCiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZEFwcGxpYW5jZShkaXNjb3ZlcnlBcHBsaWFuY2UpCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICBqZCA9IDAKICAgICAgICAgIGZvciBhcHBsaWFuY2UgaW4gYXBwbGlhbmNlczogICAgICAgICAgCiAgICAgICAgICAgIGpkICs9IDEKICAgICAgICAgICAgdHlwZSA9IE5vbmUKICAgICAgICAgICAgb25PZmYgPSBhcHBsaWFuY2UuZ2V0KCdvbk9mZicpOwogICAgICAgICAgICBpZiBvbk9mZiBpcyBub3QgTm9uZToKICAgICAgICAgICAgICB0eXBlID0gJ1N3aXRjaGFibGUnCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgb24gPSBhcHBsaWFuY2UuZ2V0KCdvbicpCiAgICAgICAgICAgICAgb2ZmID0gYXBwbGlhbmNlLmdldCgnb2ZmJykKICAgICAgICAgICAgICBpZiBvbiBpcyBub3QgTm9uZSBhbmQgb2ZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHlwZSA9ICdTd2l0Y2hhYmxlJwogICAgICAgICAgICAgIGVsaWYgb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0eXBlID0gJ1N3aXRjaE9uJwogICAgICAgICAgICAgIGVsaWYgb2ZmIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHlwZSA9ICdTd2l0Y2hPZmYnCiAgICAgICAgICAgIHBlcmNlbnQgPSBhcHBsaWFuY2UuZ2V0KCdwZXJjZW50Jyk7CiAgICAgICAgICAgIGlmIHBlcmNlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgdHlwZSA9ICdMaWdodGluZycKICAgICAgICAgICAgaWYgcm9vbSBpcyBub3QgTm9uZSBhbmQgcm9vbSAhPSAiIjoKICAgICAgICAgICAgICBpZiBqZCA9PSAxOgogICAgICAgICAgICAgICAgaWYgZGV2aWNlLmdldCgndGFyZ2V0VGVtcGVyYXR1cmUnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIsIHJvb20sICJUaGVybW9zdGF0IikKICAgICAgICAgICAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkQXBwbGlhbmNlKGRpc2NvdmVyeUFwcGxpYW5jZSkKICAgICAgICAgICAgICAgIGVsaWYgY3VzdG9tU2tpbGw6CiAgICAgICAgICAgICAgICAgIGlmIChkZXZpY2UuZ2V0KCdhY3R1YWxUZW1wZXJhdHVyZScpIGlzIG5vdCBOb25lCiAgICAgICAgICAgICAgICAgICAgb3IgZGV2aWNlLmdldCgndGV4dCcpIGlzIG5vdCBOb25lKToKICAgICAgICAgICAgICAgICAgICBkaXNjb3ZlcnlBcHBsaWFuY2UgPSBBbWF6b25FY2hvLkRpc2NvdmVyeUFwcGxpYW5jZShpZFN0ciwgcm9vbSwgTm9uZSkKICAgICAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5hZGRBcHBsaWFuY2UoZGlzY292ZXJ5QXBwbGlhbmNlKQogICAgICAgICAgICAgIG5hbWUgPSBhcHBsaWFuY2UuZ2V0KCduYW1lJykKICAgICAgICAgICAgICBpZiBuYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBuYW1lID0gcm9vbQogICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBuYW1lID0gcm9vbSArICIgIiArIG5hbWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICBuYW1lID0gYXBwbGlhbmNlLmdldCgnbmFtZScpCiAgICAgICAgICAgICAgaWYgbmFtZSBpcyBOb25lOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgamRTdHIgPSBhcHBsaWFuY2UuZ2V0KCdpZCcpCiAgICAgICAgICAgIGlmIGpkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgICAgamRTdHIgPSBzdHIoamQpCiAgICAgICAgICAgIGlmIGN1c3RvbVNraWxsIG9yIHR5cGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIgKyAiXyIgKyBqZFN0ciwgbmFtZSwgdHlwZSkKICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5hZGRBcHBsaWFuY2UoZGlzY292ZXJ5QXBwbGlhbmNlKQogICAgICAgICAgICAgIGFsaWFzZXMgPSBhcHBsaWFuY2UuZ2V0KCdhbGlhc2VzJyk7CiAgICAgICAgICAgICAgaWYgYWxpYXNlcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGtkID0gMAogICAgICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICAgIGtkICs9IDEKICAgICAgICAgICAgICAgICAgZGlzY292ZXJ5QXBwbGlhbmNlID0gQW1hem9uRWNoby5EaXNjb3ZlcnlBcHBsaWFuY2UoaWRTdHIgKyAiXyIgKyBqZFN0ciArICJfIiArIHN0cihrZCksIGFsaWFzLCB0eXBlKQogICAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5hZGRBcHBsaWFuY2UoZGlzY292ZXJ5QXBwbGlhbmNlKQogICAgICBzZWxmLmluZm8oIkRpc2NvdmVyeSBmb3VuZCB7MH0gYXBwbGlhbmNlcy4gKG1lc3NhZ2VJZD0nezF9JykuIiwgcmVzcG9uc2VPYmplY3QuZ2V0TnJPZkFwcGxpYW5jZXMoKSwgbWVzc2FnZUlkKQogICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgIGRlZiBjb250cm9sKHNlbGYsIG1lc3NhZ2VJZCwgYXBwbGlhbmNlSWQsIHJlcXVlc3QsIHZhbHVlKToKICAgICAgcmVzcG9uc2VPYmplY3QgPSBBbWF6b25FY2hvLkNvbnRyb2xSZXNwb25zZShtZXNzYWdlSWQpCiAgICAgIGFwcGxpYW5jZXNUZXh0SXNFbXB0eSA9IFRydWUKICAgICAgYXBwbGlhbmNlc1RleHRQYXJ0MSA9IHNlbGYubG9jYWxzWydTTiddWzJdCiAgICAgIGlmIGFwcGxpYW5jZXNUZXh0UGFydDEgaXMgbm90IE5vbmUgYW5kIHR5cGUoYXBwbGlhbmNlc1RleHRQYXJ0MSkgaXMgc3RyIGFuZCBhcHBsaWFuY2VzVGV4dFBhcnQxLnN0cmlwKCkgIT0gIiI6CiAgICAgICAgYXBwbGlhbmNlc1RleHRJc0VtcHR5ID0gRmFsc2UKICAgICAgaWYgYXBwbGlhbmNlc1RleHRJc0VtcHR5OgogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIk5vU3VjaFRhcmdldEVycm9yIikKICAgICAgICByZXNwb25zZU9iamVjdC5hZGRQYXlsb2FkKCJlcnJvciIsICJjb2RlIiwgIkFFXzEwIikKICAgICAgICByZXNwb25zZU9iamVjdC5hZGRQYXlsb2FkKCJlcnJvciIsICJtc2ciLCAiYXBwbGlhbmNlIGNvbmZpZ3VyYXRpb24gaXMgZW1wdHkiKQogICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICBhcHBsaWFuY2UgPSBzZWxmLmZpbmRBcHBsaWFuY2UoYXBwbGlhbmNlSWQpCiAgICAgIGlmIGFwcGxpYW5jZSBpcyBOb25lOgogICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JyBub3QgZm91bmQuIChtZXNzYWdlSWQ9J3sxfScpIiwgYXBwbGlhbmNlSWQsIG1lc3NhZ2VJZCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJOb1N1Y2hUYXJnZXRFcnJvciIpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAiY29kZSIsICJBRV8xMSIpCiAgICAgICAgcmVzcG9uc2VPYmplY3QuYWRkUGF5bG9hZCgiZXJyb3IiLCAibXNnIiwgImFwcGxpYW5jZSBub3QgZm91bmQiKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwgImFwcGxpYW5jZUlkIiwgYXBwbGlhbmNlSWQpCiAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgIHRyeToKICAgICAgICBvblZhbHVlID0gMS4wCiAgICAgICAgb2ZmVmFsdWUgPSAwLjAKICAgICAgICBpZiByZXF1ZXN0ID09ICdUdXJuT25SZXF1ZXN0JyBvciByZXF1ZXN0ID09ICdUdXJuT2ZmUmVxdWVzdCc6CiAgICAgICAgICBhcHBsaWFuY2VWYWx1ZSA9IGFwcGxpYW5jZS5nZXQoJ29uVmFsdWUnKQogICAgICAgICAgaWYgYXBwbGlhbmNlVmFsdWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICBvblZhbHVlID0gZmxvYXQoYXBwbGlhbmNlVmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiBpbGxlZ2FsIGRlZmF1bHQgdmFsdWU9J3swfScgKG5vdCBwYXJzZWFibGUgYXMgZmxvYXQpIGZvciBhcHBsaWFuY2Ugd2l0aCBpZD0nezF9Jy4gKHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9JykiLCBhcHBsaWFuY2VWYWx1ZSwgYXBwbGlhbmNlSWQsIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZFRhcmdldFNldHRpbmdFcnJvciIpCiAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICBhdHRyaWJ1dGVOYW1lID0gTm9uZQogICAgICAgICAgaWYgYXBwbGlhbmNlLmdldCgnb25PZmYnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9ICdvbk9mZicKICAgICAgICAgIGlmIHJlcXVlc3QgPT0gJ1R1cm5PblJlcXVlc3QnOgogICAgICAgICAgICBpZiBhdHRyaWJ1dGVOYW1lIGlzIE5vbmU6CiAgICAgICAgICAgICAgaWYgYXBwbGlhbmNlLmdldCgnb24nKSBpcyBOb25lIGFuZCBhcHBsaWFuY2UuZ2V0KCdvZmYnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlVuc3VwcG9ydGVkT3BlcmF0aW9uRXJyb3IiKQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9ICdvbicKICAgICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCBhdHRyaWJ1dGVOYW1lLCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHNlbGYuX0tOWFNldFZhbHVlKGtvLCBvblZhbHVlLCAiVHVybk9uQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ1R1cm5PZmZSZXF1ZXN0JzoKICAgICAgICAgICAgaWYgYXR0cmlidXRlTmFtZSBpcyBOb25lOgogICAgICAgICAgICAgIGlmIGFwcGxpYW5jZS5nZXQoJ29mZicpIGlzIE5vbmUgYW5kIGFwcGxpYW5jZS5nZXQoJ29uJykgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJVbnN1cHBvcnRlZE9wZXJhdGlvbkVycm9yIikKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUgPSAnb2ZmJwogICAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsIGF0dHJpYnV0ZU5hbWUsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgcmVxdWVzdD0nezJ9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgc2VsZi5fS05YU2V0VmFsdWUoa28sIG9mZlZhbHVlLCAiVHVybk9mZkNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnU2V0UGVyY2VudGFnZVJlcXVlc3QnIG9yIHJlcXVlc3QgPT0gJ0luY3JlbWVudFBlcmNlbnRhZ2VSZXF1ZXN0JyBvciByZXF1ZXN0ID09ICdEZWNyZW1lbnRQZXJjZW50YWdlUmVxdWVzdCc6CiAgICAgICAgICB0cnk6CiAgICAgICAgICAgIGZ2YWx1ZSA9IGZsb2F0KHZhbHVlKQogICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHNlbGYuZXJyb3IodSJJbGxlZ2FsIHJlcXVlc3QgdmFsdWU9J3swfScgKG5vdCBwYXJzZWFibGUgYXMgZmxvYXQpIGZvciBhcHBsaWFuY2Ugd2l0aCBpZD0nezF9Jy4gKHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9JykiLCB2YWx1ZSwgYXBwbGlhbmNlSWQsIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVW5zdXBwb3J0ZWRUYXJnZXRTZXR0aW5nRXJyb3IiKQogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2VPYmplY3QKICAgICAgICAgIGtvID0gc2VsZi5maW5kS08oYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgJ3BlcmNlbnQnLCBtZXNzYWdlSWQpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCB2YWx1ZT0nezR9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCwgdmFsdWUpCiAgICAgICAgICBpZiByZXF1ZXN0ID09ICdTZXRQZXJjZW50YWdlUmVxdWVzdCc6CiAgICAgICAgICAgIHNlbGYuX0tOWFNldFBlcmNlbnQoa28sIGZ2YWx1ZSwgIlNldFBlcmNlbnRhZ2VDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnSW5jcmVtZW50UGVyY2VudGFnZVJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLl9LTlhBZGRQZXJjZW50KGtvLCBmdmFsdWUsIDEsICJJbmNyZW1lbnRQZXJjZW50YWdlQ29uZmlybWF0aW9uIiwgcmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0RlY3JlbWVudFBlcmNlbnRhZ2VSZXF1ZXN0JzoKICAgICAgICAgICAgc2VsZi5fS05YQWRkUGVyY2VudChrbywgZnZhbHVlLCAtMSwgIkRlY3JlbWVudFBlcmNlbnRhZ2VDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ1NldFRhcmdldFRlbXBlcmF0dXJlUmVxdWVzdCcgb3IgcmVxdWVzdCA9PSAnSW5jcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JyBvciByZXF1ZXN0ID09ICdEZWNyZW1lbnRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAgdHJ5OgogICAgICAgICAgICBmdmFsdWUgPSBmbG9hdCh2YWx1ZSkKICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBzZWxmLmVycm9yKHUiSWxsZWdhbCByZXF1ZXN0IHZhbHVlPSd7MH0nIChub3QgcGFyc2VhYmxlIGFzIGZsb2F0KSBmb3IgYXBwbGlhbmNlIHdpdGggaWQ9J3sxfScuIChyZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScpIiwgdmFsdWUsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlVuc3VwcG9ydGVkVGFyZ2V0U2V0dGluZ0Vycm9yIikKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlT2JqZWN0CiAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsICd0YXJnZXRUZW1wZXJhdHVyZScsIG1lc3NhZ2VJZCkKICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIHZhbHVlPSd7NH0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkLCB2YWx1ZSkKICAgICAgICAgIGlmIHJlcXVlc3QgPT0gJ1NldFRhcmdldFRlbXBlcmF0dXJlUmVxdWVzdCc6CiAgICAgICAgICAgIHNlbGYuX0tOWFNldFRlbXBlcmF0dXJlKGtvLCBmdmFsdWUsICJTZXRUYXJnZXRUZW1wZXJhdHVyZUNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdJbmNyZW1lbnRUYXJnZXRUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAgICBzZWxmLl9LTlhBZGRUZW1wZXJhdHVyZShrbywgZnZhbHVlLCAxLCAiSW5jcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVDb25maXJtYXRpb24iLCByZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnRGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JzoKICAgICAgICAgICAgc2VsZi5fS05YQWRkVGVtcGVyYXR1cmUoa28sIGZ2YWx1ZSwgLTEsICJEZWNyZW1lbnRUYXJnZXRUZW1wZXJhdHVyZUNvbmZpcm1hdGlvbiIsIHJlc3BvbnNlT2JqZWN0KQogICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnR2V0VGV4dFJlcXVlc3QnOgogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAndGV4dCcsIG1lc3NhZ2VJZCkKICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICB2YWx1ZSA9IGtvLmdldFdlcnQoKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiR2V0VGV4dENvbmZpcm1hdGlvbiIpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXRQYXlsb2FkKCJ0ZXh0IiwgdmFsdWUsIGtvLkZvcm1hdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0dldFZhbHVlUmVxdWVzdCc6CiAgICAgICAgICBrbyA9IHNlbGYuZmluZEtPKGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsICd2YWx1ZScsIG1lc3NhZ2VJZCkKICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICB2YWx1ZSA9IGtvLmdldFdlcnQoKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiR2V0VmFsdWVDb25maXJtYXRpb24iKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0UGF5bG9hZCgidmFsdWUiLCB2YWx1ZSwga28uRm9ybWF0LCBhcHBsaWFuY2UuZ2V0KCJ1bml0IikpCiAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdHZXRPbk9mZlZhbHVlUmVxdWVzdCc6CiAgICAgICAgICBpZiBhcHBsaWFuY2UuZ2V0KCdvbk9mZicpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lID0gJ29uT2ZmJwogICAgICAgICAgZWxpZiBhcHBsaWFuY2UuZ2V0KCdvbicpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lID0gJ29uJwogICAgICAgICAgZWxpZiBhcHBsaWFuY2UuZ2V0KCdvZmYnKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSA9ICdvZmYnCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBBbWF6b25FY2hvLkVycm9yKCJhdHRyaWJ1dGUgbm90IGZvdW5kIiwgIkFFXzEyIiwgeyJhcHBsaWFuY2VJZCI6YXBwbGlhbmNlSWQsICJhdHRyaWJ1dGVOYW1lIjoib25PZmYifSkKICAgICAgICAgIGtvID0gc2VsZi5maW5kS08oYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgYXR0cmlidXRlTmFtZSwgbWVzc2FnZUlkKQogICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgcmVxdWVzdD0nezJ9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgIHZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJHZXRPbk9mZlZhbHVlQ29uZmlybWF0aW9uIikKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFBheWxvYWQoIm9uT2ZmIiwgdmFsdWUsIGtvLkZvcm1hdCkKICAgICAgICBlbGlmIHJlcXVlc3QgPT0gJ0dldFBlcmNlbnRWYWx1ZVJlcXVlc3QnOgogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAncGVyY2VudCcsIG1lc3NhZ2VJZCkKICAgICAgICAgIHZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgICAgICBzZWxmLmluZm8odSJDb250cm9sIGFwcGxpYW5jZSB3aXRoIGlkPSd7MH0nLCBuYW1lPSd7MX0nLCByZXF1ZXN0PSd7Mn0nLCBtZXNzYWdlSWQ9J3szfScuIiwgYXBwbGlhbmNlSWQsIGtvLlJQQ1RleHQuZGVjb2RlKCdpc284ODU5LTEnKSwgcmVxdWVzdCwgbWVzc2FnZUlkKQogICAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiR2V0UGVyY2VudFZhbHVlQ29uZmlybWF0aW9uIikKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFBheWxvYWQoInBlcmNlbnQiLCB2YWx1ZSwga28uRm9ybWF0KQogICAgICAgIGVsaWYgcmVxdWVzdCA9PSAnR2V0VGFyZ2V0VGVtcGVyYXR1cmVSZXF1ZXN0JzoKICAgICAgICAgIGtvID0gc2VsZi5maW5kS08oYXBwbGlhbmNlSWQsIGFwcGxpYW5jZSwgJ3RhcmdldFRlbXBlcmF0dXJlJywgbWVzc2FnZUlkKQogICAgICAgICAgdmFsdWUgPSBrby5nZXRXZXJ0KCkKICAgICAgICAgIHNlbGYuaW5mbyh1IkNvbnRyb2wgYXBwbGlhbmNlIHdpdGggaWQ9J3swfScsIG5hbWU9J3sxfScsIHJlcXVlc3Q9J3syfScsIG1lc3NhZ2VJZD0nezN9Jy4iLCBhcHBsaWFuY2VJZCwga28uUlBDVGV4dC5kZWNvZGUoJ2lzbzg4NTktMScpLCByZXF1ZXN0LCBtZXNzYWdlSWQpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJHZXRUYXJnZXRUZW1wZXJhdHVyZUNvbmZpcm1hdGlvbiIpCiAgICAgICAgICByZXNwb25zZU9iamVjdC5zZXRQYXlsb2FkKCJ0YXJnZXRUZW1wZXJhdHVyZSIsIHZhbHVlLCBrby5Gb3JtYXQpCiAgICAgICAgZWxpZiByZXF1ZXN0ID09ICdHZXRBY3R1YWxUZW1wZXJhdHVyZVJlcXVlc3QnOgogICAgICAgICAga28gPSBzZWxmLmZpbmRLTyhhcHBsaWFuY2VJZCwgYXBwbGlhbmNlLCAnYWN0dWFsVGVtcGVyYXR1cmUnLCBtZXNzYWdlSWQpCiAgICAgICAgICB2YWx1ZSA9IGtvLmdldFdlcnQoKQogICAgICAgICAgc2VsZi5pbmZvKHUiQ29udHJvbCBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JywgbmFtZT0nezF9JywgcmVxdWVzdD0nezJ9JywgbWVzc2FnZUlkPSd7M30nLiIsIGFwcGxpYW5jZUlkLCBrby5SUENUZXh0LmRlY29kZSgnaXNvODg1OS0xJyksIHJlcXVlc3QsIG1lc3NhZ2VJZCkKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIkdldEFjdHVhbFRlbXBlcmF0dXJlQ29uZmlybWF0aW9uIikKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldFBheWxvYWQoImFjdHVhbFRlbXBlcmF0dXJlIiwgdmFsdWUsIGtvLkZvcm1hdCkKICAgICAgZXhjZXB0IEFtYXpvbkVjaG8uRXJyb3IgYXMgZXg6CiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiTm9TdWNoVGFyZ2V0RXJyb3IiKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwgImNvZGUiLCBleC5jb2RlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LmFkZFBheWxvYWQoImVycm9yIiwgIm1zZyIsIGV4LnZhbHVlKQogICAgICAgIGlmIGV4LmRpY3QgaXMgbm90IE5vbmU6CiAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBleC5kaWN0Lml0ZXJpdGVtcygpOgogICAgICAgICAgICByZXNwb25zZU9iamVjdC5hZGRQYXlsb2FkKCJlcnJvciIsIGtleSwgdmFsdWUpCiAgICAgIGlmIHJlc3BvbnNlT2JqZWN0LmdldE5hbWUoKSBpcyBOb25lOgogICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiB1bnN1cHBvcnRlZCBvcGVyYXRpb24gJ3swfScgZm9yIGFwcGxpYW5jZSB3aXRoIGlkPSd7MX0nLiAobWVzc2FnZUlkPSd7Mn0nKSIsIHJlcXVlc3QsIGFwcGxpYW5jZUlkLCBtZXNzYWdlSWQpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVW5zdXBwb3J0ZWRPcGVyYXRpb25FcnJvciIpCiAgICAgIHJldHVybiByZXNwb25zZU9iamVjdAogICAgY2xhc3MgRXJyb3IoRXhjZXB0aW9uKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIHZhbHVlLCBjb2RlLCBkaWN0PU5vbmUpOgogICAgICAgIHNlbGYudmFsdWUgPSB2YWx1ZQogICAgICAgIHNlbGYuY29kZSA9IGNvZGUKICAgICAgICBzZWxmLmRpY3QgPSBkaWN0CiAgICAgIGRlZiBfX3N0cl9fKHNlbGYpOgogICAgICAgIHJldHVybiByZXByKHNlbGYudmFsdWUpCiAgICBkZWYgZmluZEtPKHNlbGYsIGFwcGxpYW5jZUlkLCBhcHBsaWFuY2UsIGF0dHJpYnV0ZU5hbWUsIG1lc3NhZ2VJZCk6CiAgICAgIGF0dHJpYnV0ZVZhbHVlID0gYXBwbGlhbmNlLmdldChhdHRyaWJ1dGVOYW1lKQogICAgICBpZiBhdHRyaWJ1dGVWYWx1ZSBpcyBOb25lOgogICAgICAgIHNlbGYuZXJyb3IodSJDb250cm9sOiBhcHBsaWFuY2Ugd2l0aCBpZD0nezB9JyBoYXMgbm8gJ3sxfScgYXR0cmlidXRlLiAobWVzc2FnZUlkPSd7Mn0nKSIsIGFwcGxpYW5jZUlkLCBhdHRyaWJ1dGVOYW1lLCBtZXNzYWdlSWQpCiAgICAgICAgcmFpc2UgQW1hem9uRWNoby5FcnJvcigiYXR0cmlidXRlIG5vdCBmb3VuZCIsICJBRV8xMiIsIHsiYXBwbGlhbmNlSWQiOmFwcGxpYW5jZUlkLCAiYXR0cmlidXRlTmFtZSI6YXR0cmlidXRlTmFtZX0pCiAgICAgIGtvID0gc2VsZi5fZmluZEtvKGF0dHJpYnV0ZVZhbHVlKQogICAgICBpZiBrbyBpcyBOb25lOgogICAgICAgIHNlbGYuZXJyb3IoIkNvbnRyb2w6IEtPLW9iamVjdCBmb3IgZ3JvdXAgYWRkcmVzcyB7MH09J3sxfScgY291bGQgbm90IGJlIGZvdW5kLiAobWVzc2FnZUlkPSd7Mn0nKSIsIGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlLCBtZXNzYWdlSWQpCiAgICAgICAgcmFpc2UgQW1hem9uRWNoby5FcnJvcigiS08tb2JqZWN0IG5vdCBmb3VuZCIsICJBRV8xMyIsIHsiYXBwbGlhbmNlSWQiOmFwcGxpYW5jZUlkLCAiYXR0cmlidXRlVmFsdWUiOmF0dHJpYnV0ZVZhbHVlfSkKICAgICAgcmV0dXJuIGtvCiAgICBkZWYgX2ZpbmRLbyhzZWxmLCBncnBBZHJTdHIpOgogICAgICBmb3IgaWtvIGluIHNlbGYuTUMuVGFnTGlzdC5UYWdMaXN0OiAKICAgICAgICBrbyA9IHNlbGYuTUMuVGFnTGlzdC5UYWdMaXN0W2lrb10KICAgICAgICBpZiBrby5HcnBBZHJTdHIgPT0gZ3JwQWRyU3RyOgogICAgICAgICAgcmV0dXJuIGtvCiAgICAgIHJldHVybiBOb25lOwogICAgZGVmIF9LTlhBZGRUZW1wZXJhdHVyZShzZWxmLCBrbywgdmFsdWUsIHNpZ24sIG5hbWUsIHJlc3BvbnNlT2JqZWN0KToKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhBZGRUZW1wZXJhdHVyZShrbz0nezB9JywgdmFsdWU9J3sxfScsIHNpZ249J3syfScsIG5hbWU9J3szfSknLiIsIGtvLkdycEFkclN0ciwgdmFsdWUsIHNpZ24sIG5hbWUpCiAgICAgIG9sZFZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgIG5ld1ZhbHVlID0gb2xkVmFsdWUgKyAoc2lnbiAqIHZhbHVlKQogICAgICBpZiBvbGRWYWx1ZSA+IGtvLk1pbiBhbmQgb2xkVmFsdWUgPCBrby5NYXg6CiAgICAgICAgaWYgbmV3VmFsdWUgPCBrby5NaW46CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1pbgogICAgICAgIGVsaWYgbmV3VmFsdWUgPiBrby5NYXg6CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1heAogICAgICAgIHNlbGYuX0tOWFNlbmQoa28sIG5ld1ZhbHVlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUobmFtZSkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXRUYXJnZXRUZW1wZXJhdHVyZVBheWxvYWQoInswOjAuMWZ9Ii5mb3JtYXQob2xkVmFsdWUpLCAiezA6MC4xZn0iLmZvcm1hdChuZXdWYWx1ZSkpCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi53YXJuKHUiVmFsdWUgb3V0IG9mIHJhbmdlOiBrbz0nezB9JyBuZXdWYWx1ZT0nezF9JyBtaW49J3syfScgbWF4PSd7M30nIiwga28uR3JwQWRyU3RyLCBuZXdWYWx1ZSwga28uTWluLCBrby5NYXgpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVmFsdWVPdXRPZlJhbmdlRXJyb3IiKQogICAgZGVmIF9LTlhTZXRUZW1wZXJhdHVyZShzZWxmLCBrbywgdmFsdWUsIG5hbWUsIHJlc3BvbnNlT2JqZWN0KToKICAgICAgc2VsZi5kZWJ1Zyh1Il9LTlhTZXRUZW1wZXJhdHVyZShrbz0nezB9JywgdmFsdWU9J3sxfScsIG5hbWU9J3syfScpLiIsIGtvLkdycEFkclN0ciwgdmFsdWUsIG5hbWUpCiAgICAgIG9sZFZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0VGVtcGVyYXR1cmU6IG9sZFZhbHVlPSd7MH0nIG1pbj0nezF9JyBtYXg9J3syfSciLCBvbGRWYWx1ZSwga28uTWluLCBrby5NYXgpCiAgICAgIGlmIHZhbHVlID49IGtvLk1pbiBhbmQgdmFsdWUgPD0ga28uTWF4OgogICAgICAgIHNlbGYuX0tOWFNlbmQoa28sIHZhbHVlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUobmFtZSkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXRUYXJnZXRUZW1wZXJhdHVyZVBheWxvYWQoInswOjAuMWZ9Ii5mb3JtYXQob2xkVmFsdWUpLCAiezA6MC4xZn0iLmZvcm1hdCh2YWx1ZSkpCiAgICAgIGVsc2U6CiAgICAgICAgc2VsZi53YXJuKHUiVmFsdWUgb3V0IG9mIHJhbmdlOiBrbz0nezB9JyB2YWx1ZT0nezF9JyBtaW49J3syfScgbWF4PSd7M30nIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwga28uTWluLCBrby5NYXgpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZSgiVmFsdWVPdXRPZlJhbmdlRXJyb3IiKQogICAgZGVmIF9LTlhBZGRQZXJjZW50KHNlbGYsIGtvLCB2YWx1ZSwgc2lnbiwgbmFtZSwgcmVzcG9uc2VPYmplY3QpOgogICAgICBzZWxmLmRlYnVnKHUiX0tOWEFkZFBlcmNlbnQoa289J3swfScsIHZhbHVlPSd7MX0nLCBzaWduPSd7Mn0nLCBuYW1lPSd7M30nKSIsIGtvLkdycEFkclN0ciwgdmFsdWUsIHNpZ24sIG5hbWUpCiAgICAgIG9sZFZhbHVlID0ga28uZ2V0V2VydCgpCiAgICAgIG5ld1ZhbHVlID0gb2xkVmFsdWUgKyAoc2lnbiAqIHZhbHVlKQogICAgICBpZiBvbGRWYWx1ZSA+IGtvLk1pbiBhbmQgb2xkVmFsdWUgPCBrby5NYXg6CiAgICAgICAgaWYgbmV3VmFsdWUgPCBrby5NaW46CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1pbgogICAgICAgIGVsaWYgbmV3VmFsdWUgPiBrby5NYXg6CiAgICAgICAgICBuZXdWYWx1ZSA9IGtvLk1heAogICAgICAgIHNlbGYuX0tOWFNlbmQoa28sIG5ld1ZhbHVlKQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUobmFtZSkKICAgICAgZWxzZToKICAgICAgICBzZWxmLndhcm4odSJWYWx1ZSBvdXQgb2YgcmFuZ2U6IGtvPSd7MH0nIG5ld1ZhbHVlPSd7MX0nIG1pbj0nezJ9JyBtYXg9J3szfSciLCBrby5HcnBBZHJTdHIsIG5ld1ZhbHVlLCBrby5NaW4sIGtvLk1heCkKICAgICAgICByZXNwb25zZU9iamVjdC5zZXROYW1lKCJWYWx1ZU91dE9mUmFuZ2VFcnJvciIpCiAgICBkZWYgX0tOWFNldFBlcmNlbnQoc2VsZiwga28sIHZhbHVlLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0UGVyY2VudChrbz0nezB9JywgdmFsdWU9J3sxfScsIG5hbWU9J3syfScpIiwga28uR3JwQWRyU3RyLCB2YWx1ZSwgbmFtZSkKICAgICAgaWYgdmFsdWUgPj0ga28uTWluIGFuZCB2YWx1ZSA8PSBrby5NYXg6CiAgICAgICAgc2VsZi5fS05YU2VuZChrbywgdmFsdWUpCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgICBlbHNlOgogICAgICAgIHNlbGYud2Fybih1IlZhbHVlIG91dCBvZiByYW5nZToga289J3swfScgdmFsdWU9J3sxfScgbWluPSd7Mn0nIG1heD0nezN9JyIsIGtvLkdycEFkclN0ciwgdmFsdWUsIGtvLk1pbiwga28uTWF4KQogICAgICAgIHJlc3BvbnNlT2JqZWN0LnNldE5hbWUoIlZhbHVlT3V0T2ZSYW5nZUVycm9yIikKICAgIGRlZiBfS05YU2V0VmFsdWUoc2VsZiwga28sIHZhbHVlLCBuYW1lLCByZXNwb25zZU9iamVjdCk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2V0VmFsdWUoa289J3swfScsIHZhbHVlPSd7MX0nLCBuYW1lPSd7Mn0nKS4iLCBrby5HcnBBZHJTdHIsIHZhbHVlLCBuYW1lKQogICAgICBzZWxmLl9LTlhTZW5kKGtvLCB2YWx1ZSkKICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShuYW1lKQogICAgZGVmIF9LTlhTZW5kKHNlbGYsIGtvLCB2YWx1ZSk6CiAgICAgIHNlbGYuZGVidWcodSJfS05YU2VuZChrbz0nezB9JywgdmFsdWU9J3sxfScpOiIsIGtvLkdycEFkclN0ciwgdmFsdWUpCiAgICAgIHNlbGYubG9naWsuTUMuVGFnTGlzdC5zZXRXZXJ0KEZMQUdfRUlCX0xPR0lLLCBrbywgdmFsdWUpCiAgICBkZWYgZmluZEFwcGxpYW5jZShzZWxmLCBhcHBsaWFuY2VJZCk6CiAgICAgIHNlbGYuZGVidWcodSJmaW5kQXBwbGlhbmNlKGFwcGxpYW5jZUlkPSd7MH0nKSIsIGFwcGxpYW5jZUlkKQogICAgICBpZiBzZWxmLmFwcGxpYW5jZXMgaXMgbm90IE5vbmU6CiAgICAgICAgaWQgPSAwCiAgICAgICAgZm9yIGRldmljZSBpbiBzZWxmLmFwcGxpYW5jZXM6CiAgICAgICAgICByb29tID0gZGV2aWNlLmdldCgncm9vbScpCiAgICAgICAgICBpZCArPSAxCiAgICAgICAgICBpZFN0ciA9IGRldmljZS5nZXQoJ2lkJykKICAgICAgICAgIGlmIGlkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgIGlkU3RyID0gc3RyKGlkKQogICAgICAgICAgaWYgYXBwbGlhbmNlSWQgPT0gaWRTdHI6CiAgICAgICAgICAgIHNlbGYuZGVidWcodSJGb3VuZCByb29tPSd7MH0nLiIsIHJvb20pCiAgICAgICAgICAgIHJldHVybiBkZXZpY2UKICAgICAgICAgIGFwcGxpYW5jZXMgPSBkZXZpY2UuZ2V0KCdhcHBsaWFuY2VzJykKICAgICAgICAgIGlmIGFwcGxpYW5jZXMgaXMgTm9uZToKICAgICAgICAgICAgY29udGludWUKICAgICAgICAgIGpkID0gMAogICAgICAgICAgZm9yIGFwcGxpYW5jZSBpbiBhcHBsaWFuY2VzOgogICAgICAgICAgICBuYW1lID0gYXBwbGlhbmNlLmdldCgnbmFtZScpCiAgICAgICAgICAgIGpkICs9IDEKICAgICAgICAgICAgamRTdHIgPSBhcHBsaWFuY2UuZ2V0KCdpZCcpCiAgICAgICAgICAgIGlmIGpkU3RyIGlzIE5vbmU6CiAgICAgICAgICAgICAgamRTdHIgPSBzdHIoamQpCiAgICAgICAgICAgIGlmIGFwcGxpYW5jZUlkID09IGlkU3RyICsgIl8iICsgamRTdHI6CiAgICAgICAgICAgICAgc2VsZi5kZWJ1Zyh1IkZvdW5kIGFwcGxpYW5jZSB3aXRoIG5hbWU9J3swfScuIiwgbmFtZSkKICAgICAgICAgICAgICByZXR1cm4gYXBwbGlhbmNlCiAgICAgICAgICAgIGFsaWFzZXMgPSBhcHBsaWFuY2UuZ2V0KCdhbGlhc2VzJyk7CiAgICAgICAgICAgIGlmIGFsaWFzZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAga2QgPSAwCiAgICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICBrZCArPSAxCiAgICAgICAgICAgICAgICBpZiBhcHBsaWFuY2VJZCA9PSBpZFN0ciArICJfIiArIGpkU3RyICsgIl8iICsgc3RyKGtkKToKICAgICAgICAgICAgICAgICAgc2VsZi5kZWJ1Zyh1IkZvdW5kIGFwcGxpYW5jZSB3aXRoIGFsaWFzPSd7MH0nLiIsIGFsaWFzKQogICAgICAgICAgICAgICAgICByZXR1cm4gYXBwbGlhbmNlCiAgICAgIHJldHVybiBOb25lCiAgICBkZWYgZW5jb2RlKHNlbGYsIGtleSwgZGVjKToKICAgICAgaW1wb3J0IGJhc2U2NAogICAgICBlbmMgPSBbXQogICAgICBmb3IgaSBpbiByYW5nZShsZW4oZGVjKSk6CiAgICAgICAga2V5X2MgPSBrZXlbaSAlIGxlbihrZXkpXQogICAgICAgIGVuY19jID0gY2hyKChvcmQoZGVjW2ldKSArIG9yZChrZXlfYykpICUgMjU2KQogICAgICAgIGVuYy5hcHBlbmQoZW5jX2MpCiAgICAgIHJldHVybiBiYXNlNjQudXJsc2FmZV9iNjRlbmNvZGUoIiIuam9pbihlbmMpKQogICAgZGVmIGRlY29kZShzZWxmLCBrZXksIGVuYyk6CiAgICAgIGltcG9ydCBiYXNlNjQKICAgICAgZGVjID0gW10KICAgICAgZW5jID0gYmFzZTY0LnVybHNhZmVfYjY0ZGVjb2RlKGVuYykKICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGVuYykpOgogICAgICAgIGtleV9jID0ga2V5W2kgJSBsZW4oa2V5KV0KICAgICAgICBkZWNfYyA9IGNocigoMjU2ICsgb3JkKGVuY1tpXSkgLSBvcmQoa2V5X2MpKSAlIDI1NikKICAgICAgICBkZWMuYXBwZW5kKGRlY19jKQogICAgICByZXR1cm4gIiIuam9pbihkZWMpCiAgICBjbGFzcyBIZWFkZXIoKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIG1lc3NhZ2VJZCwgbmFtZSwgbmFtZXNwYWNlLCBwYXlsb2FkVmVyc2lvbik6CiAgICAgICAgc2VsZi5tZXNzYWdlSWQgPSBtZXNzYWdlSWQKICAgICAgICBzZWxmLm5hbWUgPSBuYW1lCiAgICAgICAgc2VsZi5uYW1lc3BhY2UgPSBuYW1lc3BhY2UKICAgICAgICBzZWxmLnBheWxvYWRWZXJzaW9uID0gcGF5bG9hZFZlcnNpb24KICAgIGNsYXNzIENvbnRyb2xSZXNwb25zZSgpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkKToKICAgICAgICBzZWxmLmhlYWRlciA9IEFtYXpvbkVjaG8uSGVhZGVyKG1lc3NhZ2VJZCwgTm9uZSwgIkFsZXhhLkNvbm5lY3RlZEhvbWUuQ29udHJvbCIsICIyIikKICAgICAgICBzZWxmLnBheWxvYWQgPSB7fQogICAgICBkZWYgc2V0TmFtZShzZWxmLCBuYW1lKToKICAgICAgICBzZWxmLmhlYWRlci5uYW1lID0gbmFtZQogICAgICBkZWYgZ2V0TmFtZShzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5oZWFkZXIubmFtZQogICAgICBkZWYgc2V0VGFyZ2V0VGVtcGVyYXR1cmVQYXlsb2FkKHNlbGYsIG9sZFZhbHVlLCBuZXdWYWx1ZSk6CiAgICAgICAgc2VsZi5wYXlsb2FkID0gewogICAgICAgICAgInRhcmdldFRlbXBlcmF0dXJlIjp7InZhbHVlIjpuZXdWYWx1ZX0sCiAgICAgICAgICAidGVtcGVyYXR1cmVNb2RlIjp7InZhbHVlIjoiQVVUTyJ9LAogICAgICAgICAgInByZXZpb3VzU3RhdGUiOnsKICAgICAgICAgICAgInRhcmdldFRlbXBlcmF0dXJlIjp7InZhbHVlIjpvbGRWYWx1ZX0sCiAgICAgICAgICAgICJtb2RlIjp7InZhbHVlIjoiQVVUTyJ9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICBkZWYgc2V0UGF5bG9hZChzZWxmLCBuYW1lLCB2YWx1ZSwgdHlwZT1Ob25lLCB1bml0PU5vbmUpOgogICAgICAgIGlmIHR5cGUgaXMgbm90IE5vbmUgYW5kIHR5cGUgPT0gMjI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlLmRlY29kZSgnaXNvODg1OS0xJykKICAgICAgICBzZWxmLmFkZFBheWxvYWQobmFtZSwgInZhbHVlIiwgdmFsdWUpCiAgICAgICAgaWYgdW5pdCBpcyBub3QgTm9uZToKICAgICAgICAgIHNlbGYuYWRkUGF5bG9hZChuYW1lLCAidW5pdCIsIHVuaXQpCiAgICAgICAgaWYgdHlwZSBpcyBub3QgTm9uZToKICAgICAgICAgIHNlbGYuYWRkUGF5bG9hZChuYW1lLCAidHlwZSIsIHR5cGUpCiAgICAgIGRlZiBhZGRQYXlsb2FkKHNlbGYsIG5hbWUsIGtleSwgdmFsdWUpOgogICAgICAgIHNlY3QgPSBzZWxmLnBheWxvYWQuZ2V0KG5hbWUpCiAgICAgICAgaWYgc2VjdCBpcyBOb25lOgogICAgICAgICAgc2VsZi5wYXlsb2FkW25hbWVdID0ge30KICAgICAgICBzZWxmLnBheWxvYWRbbmFtZV1ba2V5XSA9IHZhbHVlCiAgICBjbGFzcyBEaXNjb3ZlcnlSZXNwb25zZSgpOgogICAgICBkZWYgX19pbml0X18oc2VsZiwgbWVzc2FnZUlkKToKICAgICAgICBzZWxmLmhlYWRlciA9IEFtYXpvbkVjaG8uSGVhZGVyKG1lc3NhZ2VJZCwgIkRpc2NvdmVyQXBwbGlhbmNlc1Jlc3BvbnNlIiwgIkFsZXhhLkNvbm5lY3RlZEhvbWUuRGlzY292ZXJ5IiwgIjIiKQogICAgICAgIHNlbGYucGF5bG9hZCA9IEFtYXpvbkVjaG8uRGlzY292ZXJ5UGF5bG9hZCgpCiAgICAgIGRlZiBzZXROYW1lKHNlbGYsIG5hbWUpOgogICAgICAgIHNlbGYuaGVhZGVyLm5hbWUgPSBuYW1lCiAgICAgIGRlZiBhZGRBcHBsaWFuY2Uoc2VsZiwgYXBwbGlhbmNlKToKICAgICAgICBzZWxmLnBheWxvYWQuZGlzY292ZXJlZEFwcGxpYW5jZXMuYXBwZW5kKGFwcGxpYW5jZSkKICAgICAgZGVmIGdldE5yT2ZBcHBsaWFuY2VzKHNlbGYpOgogICAgICAgIHJldHVybiBsZW4oc2VsZi5wYXlsb2FkLmRpc2NvdmVyZWRBcHBsaWFuY2VzKQogICAgY2xhc3MgRGlzY292ZXJ5UGF5bG9hZCgpOgogICAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5kaXNjb3ZlcmVkQXBwbGlhbmNlcyA9IFtdCiAgICBjbGFzcyBEaXNjb3ZlcnlBcHBsaWFuY2UoKToKICAgICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwcGxpYW5jZUlkLCBmcmllbmRseU5hbWUsIGFwcGxpYW5jZVR5cGUpOgogICAgICAgIHNlbGYuYXBwbGlhbmNlSWQgPSBhcHBsaWFuY2VJZAogICAgICAgIHNlbGYuZnJpZW5kbHlEZXNjcmlwdGlvbiA9IGZyaWVuZGx5TmFtZQogICAgICAgIHNlbGYuZnJpZW5kbHlOYW1lID0gZnJpZW5kbHlOYW1lCiAgICAgICAgc2VsZi5pc1JlYWNoYWJsZSA9IFRydWUKICAgICAgICBzZWxmLm1hbnVmYWN0dXJlck5hbWUgPSAibi5hLiIKICAgICAgICBzZWxmLm1vZGVsTmFtZSA9ICJuLmEuIgogICAgICAgIHNlbGYudmVyc2lvbiA9ICIxLjAiCiAgICAgICAgaWYgYXBwbGlhbmNlVHlwZSA9PSAiU3dpdGNoYWJsZSI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbInR1cm5PbiIsICJ0dXJuT2ZmIl0KICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlN3aXRjaE9uIjoKICAgICAgICAgIHNlbGYuYWN0aW9ucyA9IFsidHVybk9uIl0KICAgICAgICBlbGlmIGFwcGxpYW5jZVR5cGUgPT0gIlN3aXRjaE9mZiI6CiAgICAgICAgICBzZWxmLmFjdGlvbnMgPSBbInR1cm5PZmYiXQogICAgICAgIGVsaWYgYXBwbGlhbmNlVHlwZSA9PSAiTGlnaHRpbmciOgogICAgICAgICAgc2VsZi5hY3Rpb25zID0gWyJ0dXJuT24iLCAidHVybk9mZiIsICJpbmNyZW1lbnRQZXJjZW50YWdlIiwgImRlY3JlbWVudFBlcmNlbnRhZ2UiLCAic2V0UGVyY2VudGFnZSJdCiAgICAgICAgZWxpZiBhcHBsaWFuY2VUeXBlID09ICJUaGVybW9zdGF0IjoKICAgICAgICAgIHNlbGYuYWN0aW9ucyA9IFsiaW5jcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmUiLCAiZGVjcmVtZW50VGFyZ2V0VGVtcGVyYXR1cmUiLCAic2V0VGFyZ2V0VGVtcGVyYXR1cmUiXQogICAgY2xhc3MgSFRUUFJlcXVlc3RIYW5kbGVyKEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIpOgogICAgICBkZWYgYWRkcmVzc19zdHJpbmcoc2VsZik6CiAgICAgICAgICBob3N0LCBwb3J0ID0gc2VsZi5jbGllbnRfYWRkcmVzc1s6Ml0KICAgICAgICAgIHJldHVybiBob3N0CiAgICAgIGRlZiBsb2dfcmVxdWVzdChzZWxmLCBjb2RlPU5vbmUsIHNpemU9Tm9uZSk6CiAgICAgICAgcGFzcwogICAgICBkZWYgbG9nX21lc3NhZ2Uoc2VsZiwgZm9ybWF0LCAqYXJncyk6CiAgICAgICAgcGFzcwogICAgICBkZWYgZG9fUE9TVChzZWxmKToKICAgICAgICBzZWxmLnBvc3R2YXJzID0gc2VsZi5wYXJzZV9QT1NUKCkKICAgICAgICBzZWxmLmRvX1JFUSgpCiAgICAgIGRlZiBwYXJzZV9QT1NUKHNlbGYpOgogICAgICAgIGZyb20gY2dpIGltcG9ydCBwYXJzZV9oZWFkZXIsIHBhcnNlX211bHRpcGFydAogICAgICAgIGZyb20gdXJscGFyc2UgaW1wb3J0IHBhcnNlX3FzCiAgICAgICAgY3R5cGUsIHBkaWN0ID0gcGFyc2VfaGVhZGVyKHNlbGYuaGVhZGVyc1snY29udGVudC10eXBlJ10pCiAgICAgICAgaWYgY3R5cGUgPT0gJ211bHRpcGFydC9mb3JtLWRhdGEnOgogICAgICAgICAgICBwb3N0dmFycyA9IHBhcnNlX211bHRpcGFydChzZWxmLnJmaWxlLCBwZGljdCkKICAgICAgICBlbGlmIGN0eXBlID09ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOgogICAgICAgICAgICBsZW5ndGggPSBpbnQoc2VsZi5oZWFkZXJzWydjb250ZW50LWxlbmd0aCddKQogICAgICAgICAgICBwb3N0dmFycyA9IHBhcnNlX3FzKAogICAgICAgICAgICAgICAgICAgIHNlbGYucmZpbGUucmVhZChsZW5ndGgpLCAKICAgICAgICAgICAgICAgICAgICBrZWVwX2JsYW5rX3ZhbHVlcz0xKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHBvc3R2YXJzID0ge30KICAgICAgICByZXR1cm4gcG9zdHZhcnMKICAgICAgZGVmIGRvX0dFVChzZWxmKToKICAgICAgICBzZWxmLnBvc3R2YXJzID0gTm9uZQogICAgICAgIHNlbGYuZG9fUkVRKCkKICAgICAgZGVmIGRvX1JFUShzZWxmKToKICAgICAgICBhY2Nlc3NUb2tlbiA9IE5vbmUKICAgICAgICBtZXNzYWdlSWQgPSBOb25lCiAgICAgICAgdHJ5OgogICAgICAgICAgaWR4ID0gc2VsZi5wYXRoLmluZGV4KCI/IikKICAgICAgICAgIHNlbGYuY29tbWFuZCA9IHNlbGYucGF0aFsxOmlkeF0KICAgICAgICAgIHJlcVBhcmFtcyA9IHNlbGYuX2J1aWxkUmVxUGFyYW1NYXAoc2VsZi5wYXRoW2lkeCsxOl0pCiAgICAgICAgICBhY2Nlc3NUb2tlbiA9IHJlcVBhcmFtcy5nZXQoJ2FjY2Vzc1Rva2VuJykKICAgICAgICAgIG1lc3NhZ2VJZCA9IHJlcVBhcmFtcy5nZXQoJ21lc3NhZ2VJZCcpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICBzZWxmLmNvbW1hbmQgPSBzZWxmLnBhdGhbMTpdCiAgICAgICAgaWYgc2VsZi5jb21tYW5kLmxvd2VyKCkgPT0gJ2Zhdmljb24uaWNvJzoKICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDQsICdOb3QgZm91bmQnKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYWNjZXNzVG9rZW4gaXMgTm9uZToKICAgICAgICAgIHNlbGYuc2VydmVyLnNlY3VyKCJBdHRlbXB0IHRvIGFjY2VzcyBzZXJ2aWNlIHdpdGggbm8gYWNjZXNzIHRva2VuLiIpCiAgICAgICAgICBzZWxmLnNlbmRfZXJyb3IoNDAxLCAnVW5hdXRob3JpemVkJykKICAgICAgICAgIHJldHVybgogICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29uZmlnJyBvciBzZWxmLmNvbW1hbmQgPT0gJ3Nsb3RUeXBlcyc6CiAgICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuc2VjdXIodSJBdHRlbXB0IHRvIGFjY2VzcyBzZXJ2aWNlIHdpdGggd3JvbmcgYWNjZXNzIHRva2VuLiAnezB9JyE9J3sxfSciLCBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbiwgYWNjZXNzVG9rZW4pCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDEsICdVbmF1dGhvcml6ZWQnKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5jb21tYW5kID09ICdjb25maWcnOgogICAgICAgICAgICAgIHNlbGYuX2NvbmZpZygpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgc2VsZi5fc2xvdFR5cGVzKCkKICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgc2VsZi5zZXJ2ZXIuTUMuRGVidWcuc2V0RXJyKHN5cy5leGNfaW5mbygpLCJJbnRlcm5hbCBFcnJvciIpCiAgICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig1MDAsICdJbnRlcm5hbCBFcnJvcicpCiAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBhY2Nlc3NUb2tlbiAhPSBzZWxmLnNlcnZlci5hY2Nlc3NUb2tlbjoKICAgICAgICAgIHNlbGYuc2VydmVyLnNlY3VyKHUiQXR0ZW1wdCB0byBhY2Nlc3Mgc2VydmljZSB3aXRoIHdyb25nIGFjY2VzcyB0b2tlbi4gJ3swfSchPSd7MX0nIiwgc2VsZi5zZXJ2ZXIuYWNjZXNzVG9rZW4sIGFjY2Vzc1Rva2VuKQogICAgICAgICAgc2VsZi5fc2VuZEpzb25FcnJvclJlc3BvbnNlKG1lc3NhZ2VJZCwgIlVuZXhwZWN0ZWRJbmZvcm1hdGlvblJlY2VpdmVkRXJyb3IiKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZUlkIGlzIE5vbmU6CiAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UoIiIsICJVbmV4cGVjdGVkSW5mb3JtYXRpb25SZWNlaXZlZEVycm9yIikKICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29udHJvbCc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICByZXF1ZXN0ID0gcmVxUGFyYW1zWydyZXF1ZXN0J10KICAgICAgICAgICAgICBhcHBsaWFuY2VJZCA9IHJlcVBhcmFtc1snYXBwbGlhbmNlSWQnXQogICAgICAgICAgICAgIHZhbHVlID0gcmVxUGFyYW1zLmdldCgndmFsdWUnLCBOb25lKQogICAgICAgICAgICBleGNlcHQgKEtleUVycm9yKToKICAgICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gc2VsZi5zZXJ2ZXIuY29udHJvbChtZXNzYWdlSWQsIGFwcGxpYW5jZUlkLCByZXF1ZXN0LCB2YWx1ZSkKICAgICAgICAgICAgc2VsZi5fc2VuZEpzb25SZXNwb25zZShyZXNwb25zZU9iamVjdCkKICAgICAgICAgIGVsaWYgc2VsZi5jb21tYW5kID09ICdkaXNjb3ZlcnknOgogICAgICAgICAgICBjdXN0b21Ta2lsbCA9IHJlcVBhcmFtcy5nZXQoJ2N1c3RvbVNraWxsJywgRmFsc2UpCiAgICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gc2VsZi5zZXJ2ZXIuZGlzY292ZXJ5KG1lc3NhZ2VJZCwgY3VzdG9tU2tpbGwpCiAgICAgICAgICAgIHNlbGYuX3NlbmRKc29uUmVzcG9uc2UocmVzcG9uc2VPYmplY3QpCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLl9zZW5kSnNvbkVycm9yUmVzcG9uc2UobWVzc2FnZUlkLCAiVW5leHBlY3RlZEluZm9ybWF0aW9uUmVjZWl2ZWRFcnJvciIpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgc2VsZi5zZXJ2ZXIuZXhjKCJVbmhhbmRsZWQgZXhjZXB0aW9uIG9jY3VyZWQ6IikKICAgICAgICAgIHNlbGYuX3NlbmRKc29uRXJyb3JSZXNwb25zZShtZXNzYWdlSWQsICJEcml2ZXJJbnRlcm5hbEVycm9yIikKICAgICAgZGVmIF9jb25maWcoc2VsZik6CiAgICAgICAgbXNnID0gIiIKICAgICAgICBzeW50YXhFcnJvciA9IEZhbHNlCiAgICAgICAgaWYgc2VsZi5wb3N0dmFycyBpcyBub3QgTm9uZToKICAgICAgICAgIGNvbmZMaXN0ID0gc2VsZi5wb3N0dmFycy5nZXQoJ2NvbmYnLCBOb25lKQogICAgICAgICAgaWYgY29uZkxpc3QgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIG1zZywgc3ludGF4RXJyb3IgPSBzZWxmLnNlcnZlci5zYXZlQXBwbGlhbmNlc0NvbmYoY29uZkxpc3RbMF0uc3RyaXAoKSkKICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxodG1sPjxoZWFkPjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij48dGl0bGU+QW1hem9uIEVjaG8gU2VydmljZTogSlNPTi1Db25maWd1cmF0aW9uPC90aXRsZT48L2hlYWQ+PGJvZHk+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8Zm9ybSBtZXRob2Q9InBvc3QiIGVuY3R5cGU9ImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIgYWNjZXB0LWNoYXJzZXQ9InV0Zi04Ij4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzx0YWJsZSBzdHlsZT0id2lkdGg6MTAwJTtoZWlnaHQ6MTAwJSI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHI+PHRkPjxoMT5BbWF6b24gRWNobyBTZXJ2aWNlIC0gSlNPTi1Db25maWd1cmF0aW9uPC9oMT48L3RkPjwvdHI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8dHIgc3R5bGU9ImhlaWdodDo5MCUiPjx0ZD48dGV4dGFyZWEgbmFtZT0iY29uZiIgc3R5bGU9IndpZHRoOjEwMCU7aGVpZ2h0OjEwMCUiPicpCiAgICAgICAgaWYgbXNnID09ICIiOgogICAgICAgICAgU04gPSBzZWxmLnNlcnZlci5sb2NhbHNbJ1NOJ10KICAgICAgICAgIHJlc3AgPSAiIgogICAgICAgICAgZm9yIGlkeCBpbiByYW5nZSgwLCBzZWxmLnNlcnZlci5NQVhfUEFSVCk6CiAgICAgICAgICAgIHBhcnQgPSBTTltpZHggKyAyXQogICAgICAgICAgICBpZiBwYXJ0IGlzIG5vdCBOb25lIGFuZCB0eXBlKHBhcnQpIGlzIHN0cjoKICAgICAgICAgICAgICByZXNwICs9IHBhcnQKICAgICAgICBlbHNlOgogICAgICAgICAgcmVzcCA9IGNvbmZMaXN0WzBdLnN0cmlwKCkKICAgICAgICB0cnk6CiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKHJlc3ApCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgc2VsZi5zZXJ2ZXIuZXhjKCJFbmNvZGluZyBlcnJvcjoiKQogICAgICAgICAgbXNnID0gIkVuY29kaW5nIEVycm9yIgogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzwvdGV4dGFyZWE+PC90ZD48L3RyPicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPHRyPjx0ZD48aW5wdXQgdHlwZT0ic3VibWl0Ii8+PC90ZD48L3RyPicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPHRyPjx0ZD48aHIvPkV4YW1wbGU6PHByZT48Y29kZT4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJ1tcbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICB7InJvb20iOiJL/GNoZSIsICJhcHBsaWFuY2VzIjpbeyJuYW1lIjoiRGVja2VubGV1Y2h0ZSIsICJvbk9mZiI6IjEvMi8zIn1dfSxcbicuZGVjb2RlKCdpc284ODU5LTEnKS5lbmNvZGUoJ3V0Zi04JykpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICB7InJvb20iOiJXb2huemltbWVyIiwgInRhcmdldFRlbXBlcmF0dXJlIjoiMi8yLzQiLCAiYXBwbGlhbmNlcyI6W1xuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgICAgeyJuYW1lIjoiRGVja2VubGV1Y2h0ZSIsICJvbk9mZiI6IjEvMi80IiwgInBlcmNlbnQiOiIxLzIvNSJ9LFxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgICAgeyJuYW1lIjoiU3RlaGxldWNodGUiLCAib25PZmYiOiIxLzIvNiIsICJwZXJjZW50IjoiMS8yLzciLCAiYWxpYXNlcyI6WyJTdGVobGFtcGUgV29obnppbW1lciJdfVxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgIF19LFxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgIHsiYXBwbGlhbmNlcyI6W1xuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgICAgeyJuYW1lIjoiTGljaHRzemVuZSBFc3NlbiIsICJvbk9mZiI6IjEvMy8xIiwgInZhbHVlIjoiMCJ9LFxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCcgICAgeyJuYW1lIjoiTGljaHRzemVuZSBEZWtvIiwgIm9uT2ZmIjoiMS8zLzEiLCAidmFsdWUiOiIxIn1cbicpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnICBdfVxuJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCddJykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8L2NvZGU+PC9wcmU+PC90ZD48L3RyPicpCiAgICAgICAgaWYgbXNnICE9ICIiOgogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPHRyPjx0ZD4nKQogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPGIgc3R5bGU9ImNvbG9yOnJlZCI+JykKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUobXNnKQogICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPC9iPicpCiAgICAgICAgICBpZiBzeW50YXhFcnJvcjoKICAgICAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnIChBZHZpY2U6IENvcHkmcGFzdGUgeW91ciBKU09OLUNvbmZpZ3VyYXRpb24gb24gPGEgdGFyZ2V0PSJuZXciIGhyZWY9Imh0dHA6Ly9qc29ubGludC5jb20vIj5KU09OTGludDwvYT4gdG8gdmFsaWRhdGUuKScpCiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8L3RkPjwvdHI+JykKICAgICAgICBzZWxmLndmaWxlLndyaXRlKCc8L2Zvcm0+PC9ib2R5PjwvaHRtbD4nKQogICAgICBkZWYgX3Nsb3RUeXBlcyhzZWxmKToKICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgnKQogICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxodG1sPjxoZWFkPjxtZXRhIGNoYXJzZXQ9InV0Zi04Ij48dGl0bGU+QW1hem9uIEVjaG8gU2VydmljZTogQ3VzdG9tIFNraWxsIFNsb3QgVHlwZXM8L3RpdGxlPjwvaGVhZD48Ym9keT4nKQogICAgICAgIHNlbGYud2ZpbGUud3JpdGUoJzxoMT5BbWF6b24gRWNobyBTZXJ2aWNlIC0gQ3VzdG9tIFNraWxsIFNsb3QgVHlwZXM8L2gxPicpCiAgICAgICAgaWYgc2VsZi5zZXJ2ZXIuYXBwbGlhbmNlcyBpcyBub3QgTm9uZToKICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoIjxoMj5FTlVNX1JPT008L2gyPiIpCiAgICAgICAgICByb29tcyA9IFtdCiAgICAgICAgICBmb3Igcm9vbSBpbiBzZWxmLnNlcnZlci5hcHBsaWFuY2VzOgogICAgICAgICAgICByb29tTmFtZSA9IHJvb20uZ2V0KCdyb29tJykKICAgICAgICAgICAgaWYgcm9vbU5hbWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgcm9vbXMuYXBwZW5kKHJvb21OYW1lKQogICAgICAgICAgcm9vbXMuc29ydCgpCiAgICAgICAgICBmb3Igcm9vbU5hbWUgaW4gcm9vbXM6CiAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUocm9vbU5hbWUuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCI8L2JyPiIpCiAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCI8aDI+RU5VTV9BUFBMSUFOQ0U8L2gyPiIpCiAgICAgICAgICBhcHBsaWFuY2VzRm91bmQgPSBbXQogICAgICAgICAgZm9yIHJvb20gaW4gc2VsZi5zZXJ2ZXIuYXBwbGlhbmNlczoKICAgICAgICAgICAgYXBwbGlhbmNlcyA9IHJvb20uZ2V0KCdhcHBsaWFuY2VzJykKICAgICAgICAgICAgaWYgYXBwbGlhbmNlcyBpcyBOb25lOgogICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGZvciBhcHBsaWFuY2UgaW4gYXBwbGlhbmNlczoKICAgICAgICAgICAgICBhcHBsaWFuY2VOYW1lID0gYXBwbGlhbmNlLmdldCgnbmFtZScpCiAgICAgICAgICAgICAgaWYgYXBwbGlhbmNlTmFtZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGFwcGxpYW5jZU5hbWUgPSBhcHBsaWFuY2VOYW1lLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIGFwcGxpYW5jZU5hbWUgbm90IGluIGFwcGxpYW5jZXNGb3VuZDoKICAgICAgICAgICAgICAgICAgYXBwbGlhbmNlc0ZvdW5kLmFwcGVuZChhcHBsaWFuY2VOYW1lKQogICAgICAgICAgICAgIGFsaWFzZXMgPSBhcHBsaWFuY2UuZ2V0KCdhbGlhc2VzJykKICAgICAgICAgICAgICBpZiBhbGlhc2VzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgZm9yIGFsaWFzIGluIGFsaWFzZXM6CiAgICAgICAgICAgICAgICAgIGZvciByb29tTmFtZSBpbiByb29tczoKICAgICAgICAgICAgICAgICAgICBpZiBhbGlhcy5zdGFydHN3aXRoKHJvb21OYW1lKToKICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYWxpYXNbbGVuKHJvb21OYW1lKSArIDE6XQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBlbGlmIGFsaWFzLmVuZHN3aXRoKHJvb21OYW1lKToKICAgICAgICAgICAgICAgICAgICAgIGFsaWFzID0gYWxpYXNbOmxlbihhbGlhcykgLSBsZW4ocm9vbU5hbWUpXQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgYWxpYXMgPSBhbGlhcy5zdHJpcCgpCiAgICAgICAgICAgICAgICAgIGlmIGFsaWFzIG5vdCBpbiBhcHBsaWFuY2VzRm91bmQ6IAogICAgICAgICAgICAgICAgICAgIGFwcGxpYW5jZXNGb3VuZC5hcHBlbmQoYWxpYXMpOwogICAgICAgICAgYXBwbGlhbmNlc0ZvdW5kLnNvcnQoKQogICAgICAgICAgZm9yIGFwcGxpYW5jZU5hbWUgaW4gYXBwbGlhbmNlc0ZvdW5kOgogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKGFwcGxpYW5jZU5hbWUuZW5jb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKCI8L2JyPiIpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZSgnPC9mb3JtPjwvYm9keT48L2h0bWw+JykKICAgICAgZGVmIF9zZW5kSnNvbkVycm9yUmVzcG9uc2Uoc2VsZiwgbWVzc2FnZUlkLCBlcnJvck1lc3NhZ2UpOgogICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gTm9uZQogICAgICAgIGlmIHNlbGYuY29tbWFuZCA9PSAnY29udHJvbCc6CiAgICAgICAgICByZXNwb25zZU9iamVjdCA9IEFtYXpvbkVjaG8uQ29udHJvbFJlc3BvbnNlKG1lc3NhZ2VJZCkKICAgICAgICBlbGlmIHNlbGYuY29tbWFuZCA9PSAnZGlzY292ZXJ5JzoKICAgICAgICAgIHJlc3BvbnNlT2JqZWN0ID0gQW1hem9uRWNoby5EaXNjb3ZlcnlSZXNwb25zZShtZXNzYWdlSWQpCiAgICAgICAgZWxzZToKICAgICAgICAgIHNlbGYuc2VuZF9lcnJvcig0MDQsICdOb3QgRm91bmQnKQogICAgICAgICAgcmV0dXJuCiAgICAgICAgcmVzcG9uc2VPYmplY3Quc2V0TmFtZShlcnJvck1lc3NhZ2UpCiAgICAgICAgc2VsZi5fc2VuZEpzb25SZXNwb25zZShyZXNwb25zZU9iamVjdCkKICAgICAgZGVmIF9zZW5kSnNvblJlc3BvbnNlKHNlbGYsIHJlc3BvbnNlT2JqZWN0KToKICAgICAgICByZXNwID0ganNvbi5kdW1wcyhyZXNwb25zZU9iamVjdCwgZGVmYXVsdD1hc0RpY3QsIGVuY29kaW5nPSJ1dGYtOCIpCiAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcpCiAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgc2VsZi53ZmlsZS53cml0ZShyZXNwKQogICAgICBkZWYgX2J1aWxkUmVxUGFyYW1NYXAoc2VsZiwgcXVlcnkpOgogICAgICAgIGltcG9ydCB1cmxsaWIKICAgICAgICByZXFfcGFyYW1zID0ge30KICAgICAgICBwYXJhbXMgPSBxdWVyeS5zcGxpdCgnJicpCiAgICAgICAgZm9yIHBhcmFtIGluIHBhcmFtczoKICAgICAgICAgIGlkeCA9IHBhcmFtLmZpbmQoJz0nKQogICAgICAgICAgcmVxX3BhcmFtc1twYXJhbVswOmlkeF1dID0gdXJsbGliLnVucXVvdGVfcGx1cyhwYXJhbVtpZHggKyAxOl0pLmRlY29kZSgndXRmLTgnKQogICAgICAgIHJldHVybiByZXFfcGFyYW1zCiAgICBkZWYgZ2V0U1NMQ2VydChzZWxmLCBjZXJ0RmlsZW5hbWUpOgogICAgICBzZWxmLmRlYnVnKCJnZXRTU0xDZXJ0KHswfSkiLCBjZXJ0RmlsZW5hbWUpCiAgICAgIGNlcnRUZXh0ID0gIiIKICAgICAgdHJ5OgogICAgICAgIGlmIHNlbGYuSFM6CiAgICAgICAgICBjZXJ0VGV4dCA9IHNlbGYuTUMuR1VJLkV4dERhdFVybFtzZWxmLkZJTEVOQU1FX0NFUlQudXBwZXIoKV0uZ2V0RGF0ZW4oKQogICAgICAgICAgZGVsIHNlbGYuTUMuR1VJLkV4dERhdFVybFtzZWxmLkZJTEVOQU1FX0NFUlQudXBwZXIoKV0gCiAgICAgICAgZWxzZToKICAgICAgICAgIHdpdGggb3BlbignYW1hem9uRWNob1NTTC5jZXJ0JywgJ3InKSBhcyBteWZpbGU6CiAgICAgICAgICAgIGNlcnRUZXh0PW15ZmlsZS5yZWFkKCkKICAgICAgZXhjZXB0OgogICAgICAgIHNlbGYuZXhjKCJnZXRTU0xDZXJ0IEZhaWxlZCIpCiAgICAgIGlmIGNlcnRUZXh0ID09ICIiOgogICAgICAgIHNlbGYud2FybigiQ2FuJ3QgcmVhZCBhbWF6b25FY2hvU1NMLmNlcnQuIFdpbGwgdXNpbmcgaHR0cCBpbnN0ZWFkIG9mIGh0dHBzLiIpCiAgICAgIHJldHVybiBjZXJ0VGV4dAogICAgZGVmIGdldFNTTENlcnRPbGQoc2VsZiwgaXAsIHBvcnQsIGNlcnRGaWxlbmFtZSk6CiAgICAgIHNlbGYuZGVidWcoImdldFNTTENlcnRPbGQoezB9LCB7MX0sIHsyfSkiLCBpcCwgcG9ydCwgY2VydEZpbGVuYW1lKQogICAgICBpZiBzZWxmLkhTOgogICAgICAgIHRyeToKICAgICAgICAgIGltcG9ydCB1cmxsaWIyCiAgICAgICAgICB1cmwgPSAiaHR0cDovL3swfTp7MX0vb3B0L3syfSIuZm9ybWF0KGlwLCBwb3J0LCBjZXJ0RmlsZW5hbWUpCiAgICAgICAgICByZXEgPSB1cmxsaWIyLlJlcXVlc3QodXJsKQogICAgICAgICAgcmVzID0gdXJsbGliMi51cmxvcGVuKHJlcSkKICAgICAgICAgIGlmIHJlcy5nZXRjb2RlKCkgPT0gMjAwOgogICAgICAgICAgICByZXR1cm4gcmVzLmZwLnJlYWQoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgIHNlbGYuZXhjKCJnZXRTU0xDZXJ0IEZhaWxlZCIpCiAgICAgICAgICBzZWxmLndhcm4oIkdFVCBTU0wtQ2VydGlmaWNhdGUgZnJvbSBVUkw9J3swfScgZmFpbGVkLiBXaWxsIHVzaW5nIGh0dHAgaW5zdGVhZCBvZiBodHRwcy4iLCB1cmwpCiAgICAgIGVsc2U6CiAgICAgICAgd2l0aCBvcGVuKCdhbWF6b25FY2hvU1NMLmNlcnQnLCAncicpIGFzIG15ZmlsZToKICAgICAgICAgIGNlcnRUZXh0PW15ZmlsZS5yZWFkKCkKICAgICAgICByZXR1cm4gY2VydFRleHQKICAgICAgcmV0dXJuICIiCiAgICBkZWYgd2ViQ2FsbGJhY2tTU0xDZXJ0KHNlbGYsIHN0cmVhbT1GYWxzZSk6CiAgICAgIGh0bWwgPSAiPGh0bWw+PGhlYWQ+IgogICAgICBodG1sICs9ICI8bWV0YSBjaGFyc2V0PSdJU08tODg1OS0xJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdjYWNoZS1jb250cm9sJyBjb250ZW50PSdtYXgtYWdlPTAnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2NhY2hlLWNvbnRyb2wnIGNvbnRlbnQ9J25vLWNhY2hlJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdleHBpcmVzJyBjb250ZW50PScwJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdleHBpcmVzJyBjb250ZW50PSdUdWUsIDAxIEphbiAxOTgwIDE6MDA6MDAgR01UJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdwcmFnbWEnIGNvbnRlbnQ9J25vLWNhY2hlJy8+IgogICAgICBodG1sICs9ICI8dGl0bGU+QW1hem9uIEVjaG8gU2VydmljZTogU1NMIENlcnRpZmljYXRlPC90aXRsZT4iCiAgICAgIGh0bWwgKz0gIjwvaGVhZD48Ym9keT4iCiAgICAgIGh0bWwgKz0gIjxoMT5BbWF6b24gRWNobyBTZXJ2aWNlIC0gU1NMIENlcnRpZmljYXRlPC9oMT4iCiAgICAgIGh0bWwgKz0gIjxwcmU+PGNvZGU+IgogICAgICBodG1sICs9IHNlbGYuY2VydFRleHQKICAgICAgaHRtbCArPSAiPC9wcmU+PC9jb2RlPiIKICAgICAgaHRtbCArPSAiPC9ib2R5PjwvaHRtbD4iCiAgICAgIGlmIHN0cmVhbToKICAgICAgICAgIHN0cmVhbS53cml0ZShodG1sKQogICAgICBzZWxmLkRhdExlbiA9IGxlbihodG1sKQogICAgZGVmIHdlYkNhbGxiYWNrTG9nKHNlbGYsIHN0cmVhbT1GYWxzZSk6CiAgICAgIGh0bWwgPSAiPGh0bWw+PGhlYWQ+IgogICAgICBodG1sICs9ICI8bWV0YSBjaGFyc2V0PSdJU08tODg1OS0xJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdjYWNoZS1jb250cm9sJyBjb250ZW50PSdtYXgtYWdlPTAnLz4iCiAgICAgIGh0bWwgKz0gIjxtZXRhIGh0dHAtZXF1aXY9J2NhY2hlLWNvbnRyb2wnIGNvbnRlbnQ9J25vLWNhY2hlJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdleHBpcmVzJyBjb250ZW50PScwJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdleHBpcmVzJyBjb250ZW50PSdUdWUsIDAxIEphbiAxOTgwIDE6MDA6MDAgR01UJy8+IgogICAgICBodG1sICs9ICI8bWV0YSBodHRwLWVxdWl2PSdwcmFnbWEnIGNvbnRlbnQ9J25vLWNhY2hlJy8+IgogICAgICBodG1sICs9ICI8dGl0bGU+QW1hem9uIEVjaG8gU2VydmljZTogTG9nZmlsZTwvdGl0bGU+IgogICAgICBodG1sICs9ICI8L2hlYWQ+PGJvZHk+IgogICAgICBodG1sICs9ICI8aDE+QW1hem9uIEVjaG8gU2VydmljZSAtIExvZ2ZpbGU8L2gxPiIKICAgICAgaHRtbCArPSAiPGI+TG9nbGV2ZWwgPSAiCiAgICAgIGlmIHNlbGYubG9nTGV2ZWwgPT0gMDoKICAgICAgICBodG1sICs9ICIwIChPZmYpIgogICAgICBlbGlmIHNlbGYubG9nTGV2ZWwgPT0gMToKICAgICAgICBodG1sICs9ICIxIChFcnJvcikiCiAgICAgIGVsaWYgc2VsZi5sb2dMZXZlbCA9PSAyOgogICAgICAgIGh0bWwgKz0gIjIgKFdhcm4pIgogICAgICBlbGlmIHNlbGYubG9nTGV2ZWwgPT0gMzoKICAgICAgICBodG1sICs9ICIzIChJbmZvKSIKICAgICAgZWxpZiBzZWxmLmxvZ0xldmVsID09IDQ6CiAgICAgICAgaHRtbCArPSAiNCAoRGVidWcpIgogICAgICBodG1sICs9ICI8L2I+IgogICAgICBodG1sICs9ICI8cHJlPjxjb2RlPiIKICAgICAgd2l0aCBvcGVuKHNlbGYuRklMRVBBVEhfTE9HLCAncicpIGFzIG15ZmlsZToKICAgICAgICBkYXRhID0gbXlmaWxlLnJlYWQoKQogICAgICBodG1sICs9IGRhdGEKICAgICAgaHRtbCArPSAiPC9wcmU+PC9jb2RlPiIKICAgICAgaHRtbCArPSAiPC9ib2R5PjwvaHRtbD4iCiAgICAgIGlmIHN0cmVhbToKICAgICAgICAgIHN0cmVhbS53cml0ZShodG1sKQogICAgICBzZWxmLkRhdExlbiA9IGxlbihodG1sKQogICAgZGVmIGluaXRfZGVidWdfZW50cnkoc2VsZik6CiAgICAgIHByb3RvID0gImh0dHAiCiAgICAgIGlmIHNlbGYuY2VydFRleHQgIT0gIiI6CiAgICAgICAgcHJvdG8gPSAiaHR0cHMiCiAgICAgIGlkID0gJ0FtYXpvbl9FY2hvX1NlcnZpY2UnCiAgICAgIGltcG9ydCB1cmxsaWIKICAgICAgc2VsZi5NQy5EZWJ1Zy5hZGRHcnVwcGUoCiAgICAgICAgW2lkLCBpZF0sCiAgICAgICAgICBbIAogICAgICAgICAgICBbIjBWRVJTSU9OSU5GTyIsIlZlcnNpb24iLDEsJ1YwLjMgLSAoMjAxNy0wMi0xOSAxNjoyMCknXSwKICAgICAgICAgICAgWyIxUE9SVCIsIlBvcnQiLDEsc3RyKHNlbGYucG9ydCldLAogICAgICAgICAgICBbIjJTU0wiLCJTU0wtQ2VydGlmaWNhdGUiLDEsIjxhIGhyZWY9Jy9vcHQvezB9Jz5zaG93PC9hPjxicj4iLmZvcm1hdChzZWxmLlVSTF9TSE9XX1NTTCldLAogICAgICAgICAgICBbIjNMT0ciLCJMb2dmaWxlIiwxLCI8YSBocmVmPScvb3B0L3swfSc+c2hvdzwvYT48YnI+Ii5mb3JtYXQoc2VsZi5VUkxfU0hPV19MT0cpXSwKICAgICAgICAgICAgWyI0Q09ORklHIiwiSlNPTi1Db25maWd1cmF0aW9uIiwxLHUiPGEgaHJlZj0nezB9Oi8vezF9OnsyfS9jb25maWc/YWNjZXNzVG9rZW49ezN9Jz5lZGl0PC9hPjxicj4iLmZvcm1hdChwcm90bywgc2VsZi5oc0lwLCBzZWxmLnBvcnQsIHVybGxpYi5xdW90ZV9wbHVzKHNlbGYuYWNjZXNzVG9rZW4uZW5jb2RlKCd1dGYtOCcpKSldLAogICAgICAgICAgICBbIjVTTE9UVFlQRVMiLCJDdXN0b20gU2tpbGwgU2xvdCBUeXBlcyIsMSx1IjxhIGhyZWY9J3swfTovL3sxfTp7Mn0vc2xvdFR5cGVzP2FjY2Vzc1Rva2VuPXszfSc+c2hvdzwvYT48YnI+Ii5mb3JtYXQocHJvdG8sIHNlbGYuaHNJcCwgc2VsZi5wb3J0LCB1cmxsaWIucXVvdGVfcGx1cyhzZWxmLmFjY2Vzc1Rva2VuLmVuY29kZSgndXRmLTgnKSkpXSwKICAgICAgICAgIF0gICAKICAgICAgKQogICAgZGVmIHNldExvZ0xldmVsKHNlbGYsIGxldmVsKToKICAgICAgc2VsZi5sb2dMZXZlbCA9IGxldmVsCiAgICBkZWYgY2xlYXJMb2coc2VsZik6CiAgICAgIHNlbGYubG9nRmlsZS5zZWVrKDApCiAgICAgIHNlbGYubG9nRmlsZS50cnVuY2F0ZSgpCiAgICAgIHNlbGYubG9nKHNlbGYudmVyc2lvbikKICAgIGRlZiBleGMoc2VsZiwgbXNnPSIiKToKICAgICAgaWYgbXNnICE9ICIiOgogICAgICAgIHNlbGYuZXJyb3IobXNnKQogICAgICBpbXBvcnQgdHJhY2ViYWNrCiAgICAgIGV4Y01zZyA9IHRyYWNlYmFjay5mb3JtYXRfZXhjKCkKICAgICAgc2VsZi5lcnJvcihleGNNc2cpCiAgICBkZWYgc2VjdXIoc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyICs9IDEKICAgICAgc2VsZi5zZW5kVG9PdXRwdXQoMSwgc2VsZi51bmF1dGhvcml6ZWRDb3VudGVyKQogICAgICBzZWxmLl9sb2coIlNFQ1VSIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIGVycm9yKHNlbGYsIG1zZywgKnBhcmFtcyk6CiAgICAgIGlmIHNlbGYubG9nTGV2ZWwgPj0gMToKICAgICAgICBzZWxmLl9sb2coIkVSUk9SIiwgbXNnLCAqcGFyYW1zKQogICAgZGVmIHdhcm4oc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgaWYgc2VsZi5sb2dMZXZlbCA+PSAyOgogICAgICAgIHNlbGYuX2xvZygiV0FSTiAiLCBtc2csICpwYXJhbXMpCiAgICBkZWYgaW5mbyhzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBpZiBzZWxmLmxvZ0xldmVsID49IDM6CiAgICAgICAgc2VsZi5fbG9nKCJJTkZPICIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBkZWJ1ZyhzZWxmLCBtc2csICpwYXJhbXMpOgogICAgICBpZiBzZWxmLmxvZ0xldmVsID49IDQ6CiAgICAgICAgc2VsZi5fbG9nKCJERUJVRyIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBsb2coc2VsZiwgbXNnLCAqcGFyYW1zKToKICAgICAgc2VsZi5fbG9nKCJTWVMgICIsIG1zZywgKnBhcmFtcykKICAgIGRlZiBfbG9nKHNlbGYsIHByZWZpeCwgbXNnLCAqcGFyYW1zKToKICAgICAgaW1wb3J0IHRpbWUKICAgICAgdGltZXN0YW1wID0gdGltZS5zdHJmdGltZSgiJVktJW0tJWQgJUg6JU06JVMiKQogICAgICBpZiBwYXJhbXMgaXMgbm90IE5vbmUgYW5kIGxlbihwYXJhbXMpID4gMDoKICAgICAgICBtc2cgPSBtc2cuZm9ybWF0KCpwYXJhbXMpCiAgICAgIG1zZyA9IHRpbWVzdGFtcCArICIgfCAiICsgcHJlZml4ICsgIiAiICsgbXNnICsgJ1xuJwogICAgICBzZWxmLmxvZ0ZpbGUud3JpdGUobXNnKQogICAgICBzZWxmLmxvZ0ZpbGUuZmx1c2goKQogICAgZGVmIHNlbmRUb091dHB1dChzZWxmLCBvdXQsIHZhbHVlKToKICAgICAgc2VsZi5kZWJ1Zygic2VuZFRvT3V0cHV0OiB7MH0gPSAnezF9JyIsIHN0cihvdXQpLCBzdHIodmFsdWUpKQogICAgICBpZiBzZWxmLkhTOgogICAgICAgIG91dCAtPSAxICMjIEludGVybiBzdGFydGVuIGRpZSBBdXNn5G5nZSBiZWkgMCB1bmQgbmljaHQgYmVpIDEKICAgICAgICBpZiBzZWxmLmxvZ2lrLlNlbmRJbnRlcnZhbGwgPT0gMCBvciB0aW1lLnRpbWUoKSA+PSBzZWxmLmxvZ2lrLkF1c2dhbmdbb3V0XVswXToKICAgICAgICAgIGZvciBpa28gaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMV06CiAgICAgICAgICAgIHNlbGYubG9naWsuTUMuVGFnTGlzdC5zZXRXZXJ0KEZMQUdfRUlCX0xPR0lLLCBpa28sIHZhbHVlKQogICAgICAgICAgaWYgdmFsdWU6CiAgICAgICAgICAgIGZvciBjbWQgaW4gc2VsZi5sb2dpay5BdXNnYW5nW291dF1bMl06CiAgICAgICAgICAgICAgY21kLmV4ZWNCZWZlaGwoKQogICAgICAgICAgZm9yIGNvbiBpbiBzZWxmLmxvZ2lrLkF1c2dhbmdbb3V0XVszXToKICAgICAgICAgICAgc2VsZi5sb2dpay5NQy5Mb2dpa0xpc3QuQ29ubmVjdExpc3QuYXBwZW5kKGNvbiArIFsgdmFsdWUgXSkKICAgICAgICAgIGlmIHNlbGYubG9naWsuU2VuZEludGVydmFsbCA+IDA6CiAgICAgICAgICAgIHNlbGYubG9naWsuQXVzZ2FuZ1tvdXRdWzBdID0gdGltZS50aW1lKCkgKyBzZWxmLmxvZ2lrLlNlbmRJbnRlcnZhbGwKICAgICAgICAgIHNlbGYubG9naWsuT3V0V2VydFtvdXRdID0gdmFsdWUKICBnbG9iYWwgQW1hem9uRWNob1dlYkNhbGxiYWNrCiAgY2xhc3MgQW1hem9uRWNob1dlYkNhbGxiYWNrKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgcEl0ZW0sIGFtYXpvbkVjaG8sIGNhbGxiYWNrLCBuYW1lLCB0eXBlPSd0ZXh0L2h0bWwnKToKICAgICAgc2VsZi5sb2dpayA9IHBJdGVtCiAgICAgIHNlbGYuYW1hem9uRWNobyA9IGFtYXpvbkVjaG8KICAgICAgc2VsZi5jYWxsYmFjayA9IGNhbGxiYWNrCiAgICAgIHNlbGYuTUMgPSBwSXRlbS5NQwogICAgICBzZWxmLlVybFBmYWQgPSBuYW1lLnVwcGVyKCkKICAgICAgc2VsZi5EYXROYW1lID0gIk9QVC8lcyIgJSAoc2VsZi5VcmxQZmFkKQogICAgICBzZWxmLkRhdExlbiA9IDAKICAgICAgc2VsZi5UeXAgPSB0eXBlCiAgICAgIHNlbGYuaXNRdWFkID0gMAogICAgICBzZWxmLk1DLkdVSS5FeHREYXRVcmxbc2VsZi5VcmxQZmFkXSA9IHNlbGYKICAgIGRlZiBnZXREYXRlbihzZWxmKToKICAgICAgcmV0dXJuCiAgICBkZWYgZ2V0UXVhZERhdGVuKHNlbGYpOgogICAgICByZXR1cm4gCiAgICBkZWYgZ2V0RGF0ZW5TdHJlYW0oc2VsZiwgc3RyZWFtKToKICAgICAgaW1wb3J0IHRpbWUKICAgICAgc3RyZWFtLnNlZWsoMCkKICAgICAgX2hlYWRlciA9IFsKICAgICAgICAgICJIVFRQLzEuMCAyMDAgT0siLAogICAgICAgICAgIlByYWdtYTogbm8tY2FjaGUiLAogICAgICAgICAgIkNhY2hlLUNvbnRyb2w6ICBtYXgtYWdlPTAsIG5vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlIiwKICAgICAgICAgICJMYXN0LU1vZGlmaWVkOiAiICsgdGltZS5zdHJmdGltZSgiJWEsICVkICVtICVZICVIOiVNOiVTIEdNVCIsdGltZS5nbXRpbWUoKSksCiAgICAgICAgICAiQ29ubmVjdGlvbjogY2xvc2UiLAogICAgICAgICAgIkNvbnRlbnQtVHlwZTogIiArIHNlbGYuVHlwICsgIjsgY2hhcnNldD1JU08tODg1OS0xIiwKICAgICAgXQogICAgICBzdHJlYW0ud3JpdGUoIlxuIi5qb2luKF9oZWFkZXIpICsgIlxuXG4iKQogICAgICBzZWxmLkRhdExlbiA9IHNlbGYuY2FsbGJhY2soc3RyZWFtKQogICAgZGVmIGdldFF1YWREYXRlblN0cmVhbShzZWxmLCBzdHJlYW0pOgogICAgICBzZWxmLmFtYXpvbkVjaG8ud2FybigiQW1hem9uRWNob1dlYkNhbGxiYWNrICh7MH0pOiB1bmV4cGVjdGVkIGNhbGwgb2YgZ2V0UXVhZERhdGVuU3RyZWFtKCkuIiwgbmFtZSkKICAgICAgcmV0dXJuCg=='),'<13626_Amazon Echo (13626)>','exec'))"|""|0|0|0|0
## MD5 der Formelzeile: e92abd630cded7868238b1f6ab4ad783
### Klasse AmazonEcho
################################
## Quelltext nicht Öffentlich ##
################################




#5012|abbruch bei bed. (0/1)|bedingung|formel|zeit|pin-ausgang|pin-offset|pin-speicher|pin-neg.ausgang
## Klasse auf SN1 
5012|0|"EI"|"AmazonEcho(locals())"|"AmazonEcho.DELAY"|0|1|1|0
5012|0|"OC[1]"|"SN[1].init()"|""|0|0|0|0
5012|0|"EC[1] and EN[1]"|"SN[1].start()"|""|0|0|0|0
5012|0|"EC[1] and not EN[1]"|"SN[1].stop()"|""|0|0|0|0
5012|0|"EC[4]"|"SN[1].setLogLevel(EN[4])"|""|0|0|0|0
5012|0|"EC[5] and EN[5]"|"SN[1].clearLog()"|""|0|0|0|0



